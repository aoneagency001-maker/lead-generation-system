name: ðŸš€ Deploy to AWS Lambda

on:
  # Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¿Ñ€Ð¸ push Ð² main
  push:
    branches:
      - main
    paths:
      - 'telegram-notifications-service/**'
      - '.github/workflows/deploy.yml'
  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
  workflow_dispatch:
    inputs:
      stage:
        description: 'Deployment stage'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  AWS_REGION: eu-central-1
  NODE_VERSION: '18.x'

jobs:
  deploy:
    name: Deploy to AWS Lambda
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: telegram-notifications-service/package-lock.json

      - name: ðŸ“¥ Install dependencies
        working-directory: telegram-notifications-service
        run: |
          npm ci

      - name: ðŸ”¨ Build TypeScript
        working-directory: telegram-notifications-service
        run: |
          npm run build

      - name: ðŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ“¥ Load SSM parameters
        id: ssm
        working-directory: telegram-notifications-service
        run: |
          # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¸Ð· SSM
          export TELEGRAM_BOT_TOKEN=$(aws ssm get-parameter \
            --name "/telegram-notifications/BOT_TOKEN" \
            --with-decryption \
            --query 'Parameter.Value' \
            --output text \
            --region ${{ env.AWS_REGION }})
          
          export TELEGRAM_CHAT_ID=$(aws ssm get-parameter \
            --name "/telegram-notifications/CHAT_ID" \
            --query 'Parameter.Value' \
            --output text \
            --region ${{ env.AWS_REGION }} || echo "")
          
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² GitHub Actions output
          echo "TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN" >> $GITHUB_ENV
          echo "TELEGRAM_CHAT_ID=$TELEGRAM_CHAT_ID" >> $GITHUB_ENV
          
          echo "âœ… SSM parameters loaded"

      - name: ðŸ“¦ Install Serverless Framework
        run: |
          npm install -g serverless@3

      - name: ðŸš€ Deploy to AWS
        working-directory: telegram-notifications-service
        run: |
          STAGE=${{ github.event.inputs.stage || 'dev' }}
          npx serverless deploy --stage $STAGE --verbose
        env:
          TELEGRAM_BOT_TOKEN: ${{ env.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ env.TELEGRAM_CHAT_ID }}

      - name: ðŸ“‹ Get deployment info
        id: deployment
        working-directory: telegram-notifications-service
        run: |
          STAGE=${{ github.event.inputs.stage || 'dev' }}
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ endpoint URL
          ENDPOINT=$(npx serverless info --stage $STAGE --verbose 2>&1 | grep -oP 'https://[^\s]+' | head -1 || echo "")
          
          if [ -z "$ENDPOINT" ]; then
            # ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð± Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ URL
            ENDPOINT=$(aws apigatewayv2 get-apis \
              --region ${{ env.AWS_REGION }} \
              --query "Items[?contains(Name, 'telegram-notifications-service-$STAGE')].ApiEndpoint" \
              --output text | head -1)
          fi
          
          echo "endpoint=$ENDPOINT" >> $GITHUB_OUTPUT
          echo "stage=$STAGE" >> $GITHUB_OUTPUT
          
          echo "ðŸŒ Endpoint: $ENDPOINT"
          echo "ðŸ“Š Stage: $STAGE"

      - name: ðŸ§ª Test endpoints
        working-directory: telegram-notifications-service
        run: |
          ENDPOINT="${{ steps.deployment.outputs.endpoint }}"
          
          if [ -z "$ENDPOINT" ]; then
            echo "âš ï¸ Endpoint not found, skipping tests"
            exit 0
          fi
          
          echo "ðŸ§ª Testing endpoints..."
          
          # Health check
          echo "Testing /health..."
          HEALTH_RESPONSE=$(curl -s -w "\n%{http_code}" "$ENDPOINT/health" || echo "ERROR")
          HEALTH_CODE=$(echo "$HEALTH_RESPONSE" | tail -1)
          HEALTH_BODY=$(echo "$HEALTH_RESPONSE" | head -1)
          
          if [ "$HEALTH_CODE" = "200" ]; then
            echo "âœ… Health check passed"
            echo "$HEALTH_BODY" | jq '.' || echo "$HEALTH_BODY"
          else
            echo "âŒ Health check failed: HTTP $HEALTH_CODE"
            echo "$HEALTH_BODY"
            exit 1
          fi
          
          # Test track-visitor (optional, Ð½Ðµ Ð¿Ð°Ð´Ð°ÐµÐ¼ ÐµÑÐ»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ°)
          echo ""
          echo "Testing /track-visitor..."
          TRACK_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$ENDPOINT/track-visitor" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Test" \
            -d '{"clientId":"github-actions-test","page":"/test","referrer":"https://github.com"}' \
            || echo "ERROR")
          TRACK_CODE=$(echo "$TRACK_RESPONSE" | tail -1)
          TRACK_BODY=$(echo "$TRACK_RESPONSE" | head -1)
          
          if [ "$TRACK_CODE" = "200" ]; then
            echo "âœ… Track-visitor test passed"
            echo "$TRACK_BODY" | jq '.' || echo "$TRACK_BODY"
          else
            echo "âš ï¸ Track-visitor test returned HTTP $TRACK_CODE (not critical)"
            echo "$TRACK_BODY"
          fi

      - name: ðŸ“Š Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Stage:** ${{ steps.deployment.outputs.stage }}" >> $GITHUB_STEP_SUMMARY
          echo "**Endpoint:** ${{ steps.deployment.outputs.endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Endpoints:" >> $GITHUB_STEP_SUMMARY
          echo "- **GET** \`/health\` - Health check" >> $GITHUB_STEP_SUMMARY
          echo "- **POST** \`/track-visitor\` - Track visitors" >> $GITHUB_STEP_SUMMARY
          echo "- **POST** \`/tilda-webhook\` - Tilda webhook" >> $GITHUB_STEP_SUMMARY
          echo "- **POST** \`/metrika-webhook\` - Metrika webhook" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [CloudWatch Logs](https://console.aws.amazon.com/cloudwatch/home?region=${{ env.AWS_REGION }}#logsV2:log-groups)" >> $GITHUB_STEP_SUMMARY
          echo "- [Lambda Functions](https://console.aws.amazon.com/lambda/home?region=${{ env.AWS_REGION }}#/functions)" >> $GITHUB_STEP_SUMMARY
          echo "- [API Gateway](https://console.aws.amazon.com/apigateway/home?region=${{ env.AWS_REGION }}#/apis)" >> $GITHUB_STEP_SUMMARY

