#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ –∏–∑ Git –∏—Å—Ç–æ—Ä–∏–∏
# ‚ö†Ô∏è –í–ê–ñ–ù–û: –í—ã–ø–æ–ª–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è backup —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è!

set -e

echo "üîê –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ –∏–∑ Git –∏—Å—Ç–æ—Ä–∏–∏"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if [ ! -d .git ]; then
  echo "‚ùå –≠—Ç–æ –Ω–µ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π!"
  exit 1
fi

# –°–ø–∏—Å–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–¥–æ–±–∞–≤—å —Å–≤–æ–∏)
TOKENS=(
  "7848265878:AAFkCTv7xWNj7Se4RAq8XkMC_7vlxZLT0-k"
  # –î–æ–±–∞–≤—å –¥—Ä—É–≥–∏–µ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –∑–¥–µ—Å—å
)

# –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
FILES=(
  "ENV_TELEGRAM_UPDATE.md"
  # –î–æ–±–∞–≤—å –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã –∑–¥–µ—Å—å
)

echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∏–∑–º–µ–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é Git!"
echo "‚ö†Ô∏è  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å backup —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è!"
echo ""
read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (yes/no): " confirm

if [ "$confirm" != "yes" ]; then
  echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ"
  exit 0
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ git-filter-repo
if ! command -v git-filter-repo &> /dev/null; then
  echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ git-filter-repo..."
  pip install git-filter-repo
fi

# –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
for file in "${FILES[@]}"; do
  if [ -f "$file" ]; then
    echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ $file –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏..."
    git filter-repo --invert-paths --path "$file" --force
  fi
done

# –£–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω—ã –∏–∑ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
echo "üîç –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∑–∞–º–µ–Ω—ã —Ç–æ–∫–µ–Ω–æ–≤..."
cat > /tmp/token_replacements.txt << EOF
# –ó–∞–º–µ–Ω–∞ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ REMOVED
EOF

for token in "${TOKENS[@]}"; do
  echo "$token==>REMOVED" >> /tmp/token_replacements.txt
done

echo "üîÑ –ó–∞–º–µ–Ω–∞ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏–∏..."
git filter-repo --replace-text /tmp/token_replacements.txt --force

# –û—á–∏—Å—Ç–∫–∞
rm -f /tmp/token_replacements.txt

echo ""
echo "‚úÖ –°–µ–∫—Ä–µ—Ç—ã —É–¥–∞–ª–µ–Ω—ã –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ Git"
echo ""
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å force push:"
echo "   git push origin --force --all"
echo "   git push origin --force --tags"
echo ""
echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ GitHub!"
echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∑–Ω–∞—é—Ç –æ–± —ç—Ç–æ–º!"

