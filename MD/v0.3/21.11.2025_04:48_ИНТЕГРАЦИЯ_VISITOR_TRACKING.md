# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Visitor Tracking Module

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 21.11.2025 04:48

## üéØ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è [telegram-notifications-service](https://github.com/aoneagency001-maker/telegram-notifications-service) –≤ –º–æ–¥—É–ª—å **3-lead-qualification** —Å–∏—Å—Ç–µ–º—ã Lead Generation.

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

1. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è** - —Å–æ–∑–¥–∞–Ω –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å `visitor_tracking` –≤ `modules/3-lead-qualification/`
2. **API Endpoints** - –¥–≤–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö endpoint:
   - `POST /api/visitor-tracking/track-visitor` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
   - `POST /api/visitor-tracking/tilda-webhook` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—è–≤–æ–∫ —Å Tilda
3. **–°–µ—Ä–≤–∏—Å—ã**:
   - `VisitorTracker` - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
   - `TildaWebhookHandler` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook'–æ–≤
   - `BotDetector` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–æ—Ç–æ–≤ –∏ –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Ä–æ–±–æ—Ç–æ–≤
   - `GeoLocationService` - –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ IP (ip-api.com)
   - `MessageFormatter` - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è Telegram
4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π**:
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `telegram_notifier` –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   - –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ `core/api/main.py`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `supabase_client` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
5. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** - —Å–æ–∑–¥–∞–Ω–∞ —Å—Ö–µ–º–∞ `schema_visitor_tracking.sql`:
   - –¢–∞–±–ª–∏—Ü–∞ `visitors` - –¥–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è—Ö
   - –¢–∞–±–ª–∏—Ü–∞ `tilda_webhooks` - –∏—Å—Ç–æ—Ä–∏—è webhook –∑–∞–ø—Ä–æ—Å–æ–≤

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

```
modules/3-lead-qualification/visitor_tracking/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ models.py                    # Pydantic –º–æ–¥–µ–ª–∏
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ routes.py                # FastAPI —Ä–æ—É—Ç—ã
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ visitor_tracker.py       # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å
‚îÇ   ‚îú‚îÄ‚îÄ tilda_webhook.py         # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Tilda
‚îÇ   ‚îú‚îÄ‚îÄ bot_detector.py          # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–æ—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ geo_location.py          # –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ message_formatter.py    # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îî‚îÄ‚îÄ README.md
```

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ö–µ–º—É –ë–î

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Supabase Dashboard (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
1. –û—Ç–∫—Ä–æ–π Supabase Dashboard ‚Üí SQL Editor
2. –°–∫–æ–ø–∏—Ä—É–π —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `core/database/schema_visitor_tracking.sql`
3. –í—ã–ø–æ–ª–Ω–∏ SQL

**–í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç**
```bash
python scripts/apply_visitor_tracking_schema.py
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤ `.env` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:

```bash
# Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π telegram_notifier)
TELEGRAM_MONITOR_BOT_TOKEN=your_bot_token
TELEGRAM_MONITOR_CHAT_ID=your_chat_id

# Supabase
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_KEY=your_supabase_key
```

### 3. –ú–æ–¥—É–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è

–ú–æ–¥—É–ª—å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ `core/api/main.py` –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ API.

## üì° API Endpoints

### POST `/api/visitor-tracking/track-visitor`

–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram.

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```bash
curl -X POST http://localhost:8000/api/visitor-tracking/track-visitor \
  -H "Content-Type: application/json" \
  -d '{
    "page": "/ru",
    "referrer": "https://google.com",
    "screenResolution": "1920x1080",
    "utmSource": "yandex",
    "utmMedium": "cpc"
  }'
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "tracked": true,
  "visitorId": "uuid-visitor-id",
  "requestId": "abc123"
}
```

### POST `/api/visitor-tracking/tilda-webhook`

–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç webhook –æ—Ç Tilda –∏ —Å–æ–∑–¥–∞–µ—Ç –ª–∏–¥.

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```bash
curl -X POST http://localhost:8000/api/visitor-tracking/tilda-webhook \
  -H "Content-Type: application/json" \
  -d '{
    "name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
    "phone": "+7 777 123 45 67",
    "email": "ivan@example.com",
    "message": "–•–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É —Å–∞–π—Ç–∞"
  }'
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "message": "Notification sent",
  "requestId": "abc123"
}
```

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Tilda

1. –û—Ç–∫—Ä–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä–º—ã –≤ Tilda
2. –ü–µ—Ä–µ–π–¥–∏ –≤ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä–º—ã" ‚Üí "–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö"
3. –í—ã–±–µ—Ä–∏ "Webhook"
4. –£–∫–∞–∂–∏ URL: `https://your-domain.com/api/visitor-tracking/tilda-webhook`
5. –°–æ—Ö—Ä–∞–Ω–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

## üé® –§–æ—Ä–º–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ

```
üë§ –ù–æ–≤—ã–π –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—å

üÜï –¢–∏–ø: –ü–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç
üíª –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: desktop
üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: Almaty, Kazakhstan
üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞: /ru
üîó –ò—Å—Ç–æ—á–Ω–∏–∫: https://google.com
üìä UTM: Source: yandex | Medium: cpc
üñ•Ô∏è –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: 1920x1080
üïê –í—Ä–µ–º—è: 2025-11-21 12:00:00
```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞—è–≤–∫–µ —Å Tilda

```
üéØ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —Å –ª–µ–Ω–¥–∏–Ω–≥–∞!

üë§ –ò–º—è: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤
üìû –¢–µ–ª–µ—Ñ–æ–Ω: +7 777 123 45 67
üìß Email: ivan@example.com
üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ:
–•–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É —Å–∞–π—Ç–∞
üìù –§–æ—Ä–º–∞: Contact Form
üîó –°—Ç—Ä–∞–Ω–∏—Ü–∞: https://example.com/contact
üïê –í—Ä–µ–º—è: 2025-11-21 12:00:00
```

## üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –±–æ—Ç–æ–≤

–ú–æ–¥—É–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±–æ—Ç–æ–≤ –ø–æ User-Agent –∏ –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏—Ö. –°–ø–∏—Å–æ–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤–∫–ª—é—á–∞–µ—Ç:
- –ü–æ–∏—Å–∫–æ–≤—ã–µ —Ä–æ–±–æ—Ç—ã (Googlebot, Bingbot, Yandexbot)
- –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏ (Facebook, Twitter, LinkedIn)
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (Postman, curl, wget)
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã (Selenium, Puppeteer)

### –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å [ip-api.com](http://ip-api.com):
- –õ–∏–º–∏—Ç: 45 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≥–æ—Ä–æ–¥ –∏ —Å—Ç—Ä–∞–Ω—É
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (1 —á–∞—Å)

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:
- `mobile` - –º–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `tablet` - –ø–ª–∞–Ω—à–µ—Ç—ã
- `desktop` - –¥–µ—Å–∫—Ç–æ–ø—ã

### UTM-–º–µ—Ç–∫–∏

–ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ UTM-–º–µ—Ç–æ–∫ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ç—Ä–∞—Ñ–∏–∫–∞:
- `utmSource` - –∏—Å—Ç–æ—á–Ω–∏–∫
- `utmMedium` - –∫–∞–Ω–∞–ª
- `utmCampaign` - –∫–∞–º–ø–∞–Ω–∏—è
- `utmTerm` - –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ
- `utmContent` - –∫–æ–Ω—Ç–µ–Ω—Ç

## üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `visitors`

–•—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è—Ö:
- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (session_id, page, referrer)
- –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è (city, country)
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (device_type, screen_resolution)
- UTM-–º–µ—Ç–∫–∏
- –§–ª–∞–≥–∏ (is_first_visit, is_bot)

### –¢–∞–±–ª–∏—Ü–∞ `tilda_webhooks`

–•—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é webhook –∑–∞–ø—Ä–æ—Å–æ–≤:
- –°–≤—è–∑—å —Å –ª–∏–¥–æ–º (lead_id)
- –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã (form_name, page_url)
- –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (raw_data JSONB)

## ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è** - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç 45 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
2. **–ö—ç—à –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è in-memory –∫—ç—à (–¥–ª—è production –ª—É—á—à–µ Redis)
3. **Rate limiting** - –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å)

## üõ†Ô∏è –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- [ ] Rate limiting –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞
- [ ] –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π (–¥–∞—à–±–æ—Ä–¥)
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏ (–Ω–µ —Ç–æ–ª—å–∫–æ Tilda)
- [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–µ–Ω–¥–∏–Ω–≥–æ–≤
- [ ] –ö–æ–Ω–≤–µ—Ä—Å–∏–æ–Ω–Ω–∞—è –≤–æ—Ä–æ–Ω–∫–∞

## üìù –§–∞–π–ª—ã

- **–ú–æ–¥—É–ª—å:** `modules/3-lead-qualification/visitor_tracking/`
- **–°—Ö–µ–º–∞ –ë–î:** `core/database/schema_visitor_tracking.sql`
- **–°–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã:** `scripts/apply_visitor_tracking_schema.py`
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** `modules/3-lead-qualification/visitor_tracking/README.md`

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. **–ü—Ä–æ–≤–µ—Ä—å health endpoint:**
   ```bash
   curl http://localhost:8000/api/visitor-tracking/health
   ```

2. **–û—Ç–ø—Ä–∞–≤—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:**
   ```bash
   curl -X POST http://localhost:8000/api/visitor-tracking/track-visitor \
     -H "Content-Type: application/json" \
     -d '{"page": "/test"}'
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram** - –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ

## üéâ –ì–æ—Ç–æ–≤–æ!

–ú–æ–¥—É–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é. –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É Lead Generation System.

