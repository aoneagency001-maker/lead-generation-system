# üóÑÔ∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ Unified Analytics Schema

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 23.11.2025 04:15

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

–ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL —Å—Ö–µ–º—É `scripts/unified_analytics_schema.sql` –≤ Supabase –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü:
- `unified_metrics` - –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ GA4 + Yandex Metrika
- `analytics_insights` - AI-–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–µ –∏–Ω—Å–∞–π—Ç—ã (L4)
- `llm_processing_queue` - –æ—á–µ—Ä–µ–¥—å –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ LLM

---

## üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å DATABASE_PASSWORD)

–ï—Å–ª–∏ –≤ `.env` –µ—Å—Ç—å `DATABASE_PASSWORD` –∏–ª–∏ `SUPABASE_DB_PASSWORD`:

```bash
python scripts/apply_unified_analytics_schema.py
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –ü–æ–¥–∫–ª—é—á–∏—Ç—Å—è –∫ PostgreSQL —á–µ—Ä–µ–∑ psycopg2
2. –ü—Ä–∏–º–µ–Ω–∏—Ç —Å—Ö–µ–º—É
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç, —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã

---

## üìù –†—É—á–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Supabase Dashboard

### –®–∞–≥ 1: –û—Ç–∫—Ä–æ–π—Ç–µ SQL Editor

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Supabase Dashboard:
   ```
   https://supabase.com/dashboard/project/upgowxrbwjgyoqbjcegc/sql/new
   ```

2. –ò–ª–∏ —á–µ—Ä–µ–∑ –º–µ–Ω—é:
   - –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
   - –õ–µ–≤–æ–µ –º–µ–Ω—é ‚Üí **SQL Editor**
   - –ù–∞–∂–º–∏—Ç–µ **New query**

### –®–∞–≥ 2: –°–∫–æ–ø–∏—Ä—É–π—Ç–µ SQL —Å—Ö–µ–º—É

```bash
# macOS
cat scripts/unified_analytics_schema.sql | pbcopy

# Linux
cat scripts/unified_analytics_schema.sql | xclip -selection clipboard

# –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
```

### –®–∞–≥ 3: –í—Å—Ç–∞–≤—å—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ

1. –í—Å—Ç–∞–≤—å—Ç–µ SQL –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
2. –ù–∞–∂–º–∏—Ç–µ **Run** (–∏–ª–∏ `Ctrl+Enter` / `Cmd+Enter`)
3. –î–æ–∂–¥–∏—Ç–µ—Å—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–í SQL Editor –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name IN ('unified_metrics', 'analytics_insights', 'llm_processing_queue')
ORDER BY table_name;
```

–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –≤—Å–µ 3 —Ç–∞–±–ª–∏—Ü—ã.

---

## ‚úÖ –ß—Ç–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è

### 1. unified_metrics
–û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ GA4 –∏ Yandex Metrika:
- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (sessions, users, pageviews)
- Engagement –º–µ—Ç—Ä–∏–∫–∏ (bounce rate, engagement rate)
- Conversion –¥–∞–Ω–Ω—ã–µ
- Scoring (hot_score, intent_score, quality_index)
- –î–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π —Å–µ–≥–º–µ–Ω—Ç –¥–Ω—è

### 2. analytics_insights
AI-–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–µ –∏–Ω—Å–∞–π—Ç—ã:
- Executive summary
- Key findings (JSONB)
- Comparative analysis (GA4 vs Metrika)
- Segment performance
- Recommendations
- Citations (–¥–ª—è Perplexity Sonar)
- LLM metadata (model, tokens, processing time)

### 3. llm_processing_queue
–û—á–µ—Ä–µ–¥—å –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ LLM:
- Task definition (type, layer, input)
- Status tracking
- Error handling
- Timing (scheduled, started, completed)

### 4. Views
- `daily_unified_summary` - –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–≤–æ–¥–∫–∞
- `latest_insights` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–Ω—Å–∞–π—Ç—ã

### 5. Triggers
- `update_unified_metrics_updated_at` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `updated_at`

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ —Å—Ö–µ–º–µ

–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `update_updated_at_column()` –≤ —Å—Ö–µ–º—É (–µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç –≤ –±–∞–∑–µ):

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
   NEW.updated_at = CURRENT_TIMESTAMP;
   RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

---

## üìä –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã:

1. **LLM Pipeline** —Å–º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å L4 insights –≤ `analytics_insights`
2. **Frontend** —Å–º–æ–∂–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–Ω—Å–∞–π—Ç—ã —á–µ—Ä–µ–∑ `/api/llm/insights/latest`
3. **Unified metrics** –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ GA4 –∏ Metrika

---

## üêõ Troubleshooting

### –û—à–∏–±–∫–∞: "function update_updated_at_column() does not exist"

**–†–µ—à–µ–Ω–∏–µ:** –§—É–Ω–∫—Ü–∏—è —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å—Ö–µ–º—É. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
   NEW.updated_at = CURRENT_TIMESTAMP;
   RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### –û—à–∏–±–∫–∞: "relation already exists"

**–†–µ—à–µ–Ω–∏–µ:** –¢–∞–±–ª–∏—Ü—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - `CREATE TABLE IF NOT EXISTS` –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã.

### –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL

**–†–µ—à–µ–Ω–∏–µ:** 
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DATABASE_PASSWORD` –≤ `.env`
2. –ü–æ–ª—É—á–∏—Ç–µ –ø–∞—Ä–æ–ª—å –≤ Supabase Dashboard ‚Üí Settings ‚Üí Database ‚Üí Connection string
3. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ SQL Editor

---

## üìù –°—Å—ã–ª–∫–∏

- SQL —Å—Ö–µ–º–∞: `scripts/unified_analytics_schema.sql`
- –°–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è: `scripts/apply_unified_analytics_schema.py`
- Supabase Dashboard: https://supabase.com/dashboard/project/upgowxrbwjgyoqbjcegc

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 23.11.2025 04:15

