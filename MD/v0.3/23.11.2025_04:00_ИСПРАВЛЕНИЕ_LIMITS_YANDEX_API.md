# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ Yandex API –∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 23.11.2025 04:00

## ‚ùå –ü—Ä–æ–±–ª–µ–º—ã

### 1. –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç dimensions –≤ Yandex API
**–û—à–∏–±–∫–∞:** `Exceeded maximum number of groupings in request, value: 12, limit: 10`

**–ü—Ä–∏—á–∏–Ω–∞:** –í –∑–∞–ø—Ä–æ—Å–µ –±—ã–ª–æ 12 dimensions, –∞ –ª–∏–º–∏—Ç API –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∏ - 10

### 2. –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ date-only —Å—Ç—Ä–æ–∫
**–û—à–∏–±–∫–∞:** `Date-only string parsing fails in _parse_datetime method`

**–ü—Ä–∏—á–∏–Ω–∞:** `datetime.fromisoformat()` –Ω–µ –º–æ–∂–µ—Ç –ø–∞—Ä—Å–∏—Ç—å date-only —Å—Ç—Ä–æ–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "2025-11-22")

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –£–º–µ–Ω—å—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ dimensions –¥–æ 10

**–§–∞–π–ª:** `data_intake/pipeline.py`

**–ë—ã–ª–æ (12 dimensions):**
```python
"dimensions": ",".join([
    "ym:s:date",           # 1
    "ym:s:startURL",       # 2
    "ym:s:referer",        # 3
    "ym:s:UTMSource",      # 4
    "ym:s:UTMMedium",      # 5
    "ym:s:UTMCampaign",    # 6
    "ym:s:isNewUser",      # 7
    "ym:s:deviceCategory", # 8
    "ym:s:browser",        # 9 ‚ùå
    "ym:s:operatingSystem", # 10 ‚ùå
    "ym:s:regionCountry",  # 11 ‚ùå
    "ym:s:regionCity",     # 12 ‚ùå
]),
```

**–°—Ç–∞–ª–æ (10 dimensions):**
```python
"dimensions": ",".join([
    "ym:s:date",           # 1. –î–∞—Ç–∞
    "ym:s:startURL",       # 2. URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    "ym:s:referer",        # 3. –†–µ—Ñ–µ—Ä–µ—Ä
    "ym:s:UTMSource",      # 4. UTM Source
    "ym:s:UTMMedium",      # 5. UTM Medium
    "ym:s:UTMCampaign",    # 6. UTM Campaign
    "ym:s:isNewUser",      # 7. –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    "ym:s:deviceCategory", # 8. –¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    "ym:s:regionCountry",  # 9. –°—Ç—Ä–∞–Ω–∞
    "ym:s:regionCity",     # 10. –ì–æ—Ä–æ–¥
    # –£–±—Ä–∞–Ω—ã: browser, operatingSystem (–ø—Ä–µ–≤—ã—à–∞–ª–∏ –ª–∏–º–∏—Ç)
]),
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–∞—Ä—Å–∏–Ω–≥ date-only —Å—Ç—Ä–æ–∫

**–§–∞–π–ª:** `data_intake/pipeline.py`

**–ë—ã–ª–æ:**
```python
def _parse_datetime(self, value: Any) -> datetime:
    if isinstance(value, str):
        try:
            if 'T' in value or ' ' in value:
                return datetime.fromisoformat(value.replace('Z', '+00:00'))
            # Try date only - –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û!
            return datetime.combine(datetime.fromisoformat(value).date(), datetime.min.time())
```

**–°—Ç–∞–ª–æ:**
```python
def _parse_datetime(self, value: Any) -> datetime:
    if isinstance(value, str):
        try:
            # Try ISO format with time (2025-11-22T10:30:00)
            if 'T' in value or ' ' in value:
                value_clean = value.replace('Z', '+00:00')
                return datetime.fromisoformat(value_clean)
            
            # Try date only (2025-11-22) - –ü–†–ê–í–ò–õ–¨–ù–û!
            from datetime import date as date_type
            parsed_date = date_type.fromisoformat(value)
            return datetime.combine(parsed_date, datetime.min.time())
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

**–§–∞–π–ª:** `data_intake/pipeline.py`

**–ë—ã–ª–æ:**
```python
device = get_dim(7)
browser = get_dim(8)  # ‚ùå –¢–µ–ø–µ—Ä—å –Ω–µ—Ç –≤ –∑–∞–ø—Ä–æ—Å–µ
os = get_dim(9)       # ‚ùå –¢–µ–ø–µ—Ä—å –Ω–µ—Ç –≤ –∑–∞–ø—Ä–æ—Å–µ
country = get_dim(10)
city = get_dim(11)
```

**–°—Ç–∞–ª–æ:**
```python
device = get_dim(7)        # ym:s:deviceCategory
country = get_dim(8)       # ym:s:regionCountry
city = get_dim(9)          # ym:s:regionCity
# browser –∏ os —É–±—Ä–∞–Ω—ã (–ø—Ä–µ–≤—ã—à–∞–ª–∏ –ª–∏–º–∏—Ç dimensions)
```

**–ò –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ NormalizedEventCreate:**
```python
device_type=device,
browser=None,  # –£–±—Ä–∞–Ω–æ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ (–ø—Ä–µ–≤—ã—à–∞–ª–æ –ª–∏–º–∏—Ç dimensions)
os=None,      # –£–±—Ä–∞–Ω–æ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ (–ø—Ä–µ–≤—ã—à–∞–ª–æ –ª–∏–º–∏—Ç dimensions)
country=country,
city=city,
```

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å:
- ‚úÖ –ó–∞–ø—Ä–æ—Å –∫ Yandex API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 10 dimensions (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞)
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ date-only —Å—Ç—Ä–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
- ‚úÖ Pipeline –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫

---

## üß™ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å pipeline –¥–ª—è YANDEX_METRIKA:**
   - –í—ã–±—Ä–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫: YANDEX_METRIKA
   - –£–∫–∞–∑–∞—Ç—å –¥–∞—Ç—ã
   - –ù–∞–∂–∞—Ç—å "–ó–∞–ø—É—Å—Ç–∏—Ç—å"
   - –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–∫–∏ "Exceeded maximum number of groupings"

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
   - –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è L1 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å > 0
   - L2 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å > 0 (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
   - L3 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å > 0 (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è)

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

**–£–±—Ä–∞–Ω–Ω—ã–µ dimensions:**
- `ym:s:browser` - –±—Ä–∞—É–∑–µ—Ä
- `ym:s:operatingSystem` - –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

**–ü–æ—á–µ–º—É —É–±—Ä–∞–Ω—ã:**
- –õ–∏–º–∏—Ç API –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∏: –º–∞–∫—Å–∏–º—É–º 10 dimensions –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
- –≠—Ç–∏ –ø–æ–ª—è –º–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:**
–ï—Å–ª–∏ –Ω—É–∂–Ω—ã browser –∏ OS, –º–æ–∂–Ω–æ:
1. –°–¥–µ–ª–∞—Ç—å –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ (–æ–¥–∏–Ω —Å browser, –¥—Ä—É–≥–æ–π —Å OS)
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Logs API (–±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–æ —Å–ª–æ–∂–Ω–µ–µ)

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 23.11.2025 04:00

