# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ GA4 –∏ UI —É–ª—É—á—à–µ–Ω–∏—è

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 23.11.2025 03:30

## ‚ùå –ü—Ä–æ–±–ª–µ–º—ã

### 1. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è GOOGLE_ANALYTICS
**–°–∏–º–ø—Ç–æ–º:** Pipeline –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å L1=1, L2=0, L3=0

**–ü—Ä–∏—á–∏–Ω–∞:** –ú–µ—Ç–æ–¥ `_normalize_generic()` –±—ã–ª placeholder –∏ –≤–æ–∑–≤—Ä–∞—â–∞–ª –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫

### 2. –ö–Ω–æ–ø–∫–∞ "–ó–∞–≥—Ä—É–∑–∏—Ç—å Features" –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
**–°–∏–º–ø—Ç–æ–º:** –ö–Ω–æ–ø–∫–∞ –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –∫–ª–∏–∫–∏

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### 3. –û—à–∏–±–∫–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ datetime
**–°–∏–º–ø—Ç–æ–º:** "Object of type datetime is not JSON serializable"

**–ü—Ä–∏—á–∏–Ω–∞:** –í `raw_data` –º–æ–≥—É—Ç –±—ã—Ç—å datetime –æ–±—ä–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Å–µ—Ä–∏–∞–ª–∏–∑—É—é—Ç—Å—è –≤ JSON

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è GOOGLE_ANALYTICS

**–§–∞–π–ª:** `data_intake/pipeline.py`

**–ë—ã–ª–æ:**
```python
def _normalize_generic(self, raw_event: RawEvent) -> list[NormalizedEventCreate]:
    """Generic normalization for other sources."""
    # Placeholder for future sources
    return []
```

**–°—Ç–∞–ª–æ:**
```python
def _normalize_generic(self, raw_event: RawEvent) -> list[NormalizedEventCreate]:
    """
    Generic normalization for other sources (GA4, etc.).
    
    For GA4, raw_data contains {"events": [VisitEvent.model_dump(), ...]}
    We need to convert these to NormalizedEventCreate.
    """
    normalized = []
    raw_data = raw_event.raw_data
    
    # Handle GA4 format: {"events": [VisitEvent dicts]}
    if raw_event.source == SourceType.GOOGLE_ANALYTICS:
        events = raw_data.get("events", [])
        
        for event_dict in events:
            try:
                normalized_event = NormalizedEventCreate(
                    raw_event_id=raw_event.id,
                    source=SourceType.GOOGLE_ANALYTICS,
                    # ... –≤—Å–µ –ø–æ–ª—è –∏–∑ VisitEvent ...
                )
                normalized.append(normalized_event)
            except Exception as e:
                logger.warning(f"Failed to normalize GA4 event: {e}")
                continue
    
    return normalized
```

**–î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**
- `_parse_datetime()` - –ø–∞—Ä—Å–∏–Ω–≥ datetime –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
- `_parse_traffic_type()` - –ø–∞—Ä—Å–∏–Ω–≥ —Ç–∏–ø–∞ —Ç—Ä–∞—Ñ–∏–∫–∞

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è datetime

**–§–∞–π–ª:** `data_intake/database/storage.py`

**–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è:**
```python
def _serialize_for_json(self, obj: Any) -> Any:
    """
    Recursively serialize objects for JSON storage.
    Converts datetime objects to ISO format strings.
    """
    if isinstance(obj, datetime):
        return obj.isoformat()
    elif isinstance(obj, date):
        return obj.isoformat()
    elif isinstance(obj, dict):
        return {k: self._serialize_for_json(v) for k, v in obj.items()}
    elif isinstance(obj, list):
        return [self._serialize_for_json(item) for item in obj]
    else:
        return obj
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# Serialize raw_data to ensure all datetime objects are converted to strings
serialized_raw_data = self._serialize_for_json(event.raw_data)
serialized_request_params = self._serialize_for_json(event.request_params) if event.request_params else None
```

### 3. –£–ª—É—á—à–µ–Ω UI –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ó–∞–≥—Ä—É–∑–∏—Ç—å Features"

**–§–∞–π–ª:** `frontend/app/(dashboard)/dashboard/analytics/data-intake/page.tsx`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å alert
- –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ (—Å–ø–∏–Ω–Ω–µ—Ä)
- –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö

**–ö–æ–¥:**
```typescript
const loadFeatures = async () => {
  setLoadingFeatures(true);
  try {
    console.log('üîÑ Loading features...', { source: selectedSource, dateFrom, dateTo });
    const data = await apiClient.getDataIntakeFeatures({
      source: selectedSource,
      dateFrom,
      dateTo,
      limit: 100,
    });
    console.log('‚úÖ Features loaded:', data);
    setFeatures(data.items || []);
  } catch (error: any) {
    console.error('‚ùå Failed to load features:', error);
    alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ features: ${error.message || 'Unknown error'}`);
  } finally {
    setLoadingFeatures(false);
  }
};
```

### 4. –î–æ–±–∞–≤–ª–µ–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∏ –æ–ø–∏—Å–∞–Ω–∏–µ —ç—Ç–∞–ø–æ–≤

**–§–∞–π–ª:** `frontend/app/(dashboard)/dashboard/analytics/data-intake/page.tsx`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏
- –û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞:
  - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (0%)
  - –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (20%)
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ (60%)
  - –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ (90%)
  - –ì–æ—Ç–æ–≤–æ (100%)
- –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (—Å–ø–∏–Ω–Ω–µ—Ä, –≥–∞–ª–æ—á–∫–∞, –∫—Ä–µ—Å—Ç–∏–∫)
- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—à–∏–±–æ–∫

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å:
- ‚úÖ Pipeline –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –¥–∞–Ω–Ω—ã–µ GA4 (L2 > 0)
- ‚úÖ Features —Å–æ–∑–¥–∞—é—Ç—Å—è –∏–∑ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (L3 > 0)
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–ó–∞–≥—Ä—É–∑–∏—Ç—å Features" —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç—Ç–∞–ø—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- ‚úÖ –û—à–∏–±–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø–æ–Ω—è—Ç–Ω–æ

---

## üß™ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å pipeline –¥–ª—è GA4:**
   - –í—ã–±—Ä–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫: GOOGLE_ANALYTICS
   - –£–∫–∞–∑–∞—Ç—å –¥–∞—Ç—ã
   - –ù–∞–∂–∞—Ç—å "–ó–∞–ø—É—Å—Ç–∏—Ç—å"
   - –î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é:**
   - –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è L2 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å > 0
   - L3 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å > 0 (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ó–∞–≥—Ä—É–∑–∏—Ç—å Features":**
   - –û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
   - –ù–∞–∂–∞—Ç—å "–ó–∞–≥—Ä—É–∑–∏—Ç—å Features"
   - –í –∫–æ–Ω—Å–æ–ª–∏ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏
   - –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞ - –±—É–¥–µ—Ç alert

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 23.11.2025 03:30

