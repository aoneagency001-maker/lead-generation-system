# Telegram Bot - –ö–æ–º–∞–Ω–¥—ã –∏ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 19.11.2025 23:50

## üéØ –ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ

–¢–µ–ø–µ—Ä—å —Ç–≤–æ–π Telegram –±–æ—Ç **–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π** - –º–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –µ–º—É –∫–æ–º–∞–Ω–¥—ã –∏ –ø–æ–ª—É—á–∞—Ç—å –æ—Ç–≤–µ—Ç—ã!

### ‚úÖ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:

- `/start` - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
- `/status` - –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã (uptime, memory, database)
- `/health` - –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- `/stats` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
- `/help` - –°–ø—Ä–∞–≤–∫–∞ –ø–æ –≤—Å–µ–º –∫–æ–º–∞–Ω–¥–∞–º

---

## üöÄ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
cd /Users/vbut/lead-generation-system
./scripts/start_telegram_bot.sh
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ù–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ Python

```bash
cd /Users/vbut/lead-generation-system
python -m shared.telegram_bot
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –í —Ñ–æ–Ω–µ (–¥–ª—è production)

```bash
# –ò—Å–ø–æ–ª—å–∑—É–π screen –∏–ª–∏ tmux
screen -S telegram_bot
python -m shared.telegram_bot
# –ù–∞–∂–º–∏ Ctrl+A, –∑–∞—Ç–µ–º D –¥–ª—è –æ—Ç—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

# –ò–ª–∏ —á–µ—Ä–µ–∑ nohup
nohup python -m shared.telegram_bot > telegram_bot.log 2>&1 &
```

---

## üì± –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥

### 1. `/start` - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ

**–û—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É:**
```
/start
```

**–ü–æ–ª—É—á–∏—à—å:**
```
ü§ñ Lead Generation System Bot

Welcome! I'm your system monitoring bot.

Available commands:
/status - System status
/health - Health check
/stats - Statistics (24h)
/help - Help
```

---

### 2. `/status` - –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã

**–û—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É:**
```
/status
```

**–ü–æ–ª—É—á–∏—à—å:**
```
üìä System Status

üü¢ Status: Running
‚è∞ Uptime: N/A
üíæ Memory: N/A
üóÑÔ∏è Database: ‚úÖ OK
üåç Environment: Development
üì¶ Version: 0.1.0
```

---

### 3. `/health` - Health Check

**–û—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É:**
```
/health
```

**–ü–æ–ª—É—á–∏—à—å:**
```
üè• Health Check

Overall Status: ‚úÖ Healthy

Services:
‚Ä¢ Database: ‚úÖ OK
‚Ä¢ Telegram: ‚úÖ Configured
‚Ä¢ WhatsApp: ‚ö†Ô∏è Not checked
‚Ä¢ Redis: ‚ö†Ô∏è Not checked

‚úÖ All services operational
```

**–ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã:**
```
üè• Health Check

Overall Status: ‚ö†Ô∏è Degraded

Services:
‚Ä¢ Database: ‚ùå Error: Connection timeout
‚Ä¢ Telegram: ‚úÖ Configured
‚Ä¢ WhatsApp: ‚ö†Ô∏è Not checked
‚Ä¢ Redis: ‚ö†Ô∏è Not checked

‚ö†Ô∏è Issues detected:
‚Ä¢ Database unreachable
```

---

### 4. `/stats` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–û—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É:**
```
/stats
```

**–ü–æ–ª—É—á–∏—à—å:**
```
üìà Statistics (Last 24h)

üë• Leads created: 42
üöÄ Active campaigns: 3
‚ùå Errors: 0

‚è∞ Last updated: 2025-11-19 23:50:12
```

---

### 5. `/help` - –°–ø—Ä–∞–≤–∫–∞

**–û—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É:**
```
/help
```

**–ü–æ–ª—É—á–∏—à—å:**
```
üìñ Available Commands

/start - Welcome message
/status - System status (uptime, memory, database)
/health - Detailed health check of all services
/stats - Statistics for last 24 hours
/help - This help message

Examples:
‚Ä¢ Send /status to check if system is running
‚Ä¢ Send /health to verify all services
‚Ä¢ Send /stats to see recent activity

Note: This bot also sends automatic notifications about errors and system events.
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞

### –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π

–ó–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:

```bash
cd /Users/vbut/lead-generation-system
python scripts/test_telegram_bot.py
```

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**

1. ‚úÖ Success notification
2. ‚úÖ Warning notification
3. ‚úÖ Error notification
4. ‚úÖ Critical notification
5. ‚úÖ Command /start
6. ‚úÖ Command /status
7. ‚úÖ Command /health
8. ‚úÖ Command /stats
9. ‚úÖ Command /help
10. ‚úÖ Error handling

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
üß™ TELEGRAM BOT TESTING SUITE
============================================================

üìã Running: 1. Success Notification
‚úÖ 1. Success Notification - PASSED

üìã Running: 2. Warning Notification
‚úÖ 2. Warning Notification - PASSED

...

üìä TEST RESULTS
============================================================
‚úÖ Passed: 10
‚ùå Failed: 0
üìä Total: 10
============================================================
```

**–ü—Ä–æ–≤–µ—Ä—å Telegram** - –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏:
- 4 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (success, warning, error, critical)
- 5 –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –∫–æ–º–∞–Ω–¥—ã

---

## üîß –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```python
# test_notifications.py
import asyncio
from shared.telegram_notifier import telegram_notifier

async def test():
    # Success
    await telegram_notifier.send_success("Test success!", module="Test")
    
    # Warning
    await telegram_notifier.send_warning("Test warning!", module="Test")
    
    # Error
    try:
        raise ValueError("Test error")
    except Exception as e:
        await telegram_notifier.send_error(e, module="Test")
    
    # Critical
    await telegram_notifier.send_critical(
        "Test critical!",
        module="Test",
        details={"test": "value"}
    )

asyncio.run(test())
```

**–ó–∞–ø—É—Å–∫:**
```bash
python test_notifications.py
```

---

### –¢–µ—Å—Ç 2: –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

**–í–∞–∂–Ω–æ:** –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω!

1. –ó–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞ –≤ –æ–¥–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:
```bash
python -m shared.telegram_bot
```

2. –í Telegram –æ—Ç–ø—Ä–∞–≤—å –∫–æ–º–∞–Ω–¥—ã:
- `/start`
- `/status`
- `/health`
- `/stats`
- `/help`

3. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –ø–æ–ª—É—á–∞–µ—à—å –æ—Ç–≤–µ—Ç—ã

---

### –¢–µ—Å—Ç 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π

**–¢–µ—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**

1. –ó–∞–ø—É—Å—Ç–∏ FastAPI —Å–µ—Ä–≤–µ—Ä:
```bash
uvicorn core.api.main:app --reload
```

2. –í—ã–∑–æ–≤–∏ endpoint –∫–æ—Ç–æ—Ä—ã–π —É–ø–∞–¥–µ—Ç:
```bash
curl http://localhost:8000/api/test-error
```

3. –ü—Ä–æ–≤–µ—Ä—å Telegram - –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

---

## üé® –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–¥–µ

### –ü—Ä–∏–º–µ—Ä 1: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ª–∏–¥–∞

```python
# modules/3-lead-qualification/service.py
from shared.telegram_notifier import notify_success

async def create_lead(phone: str, name: str):
    lead = await db.leads.create({
        "phone": phone,
        "name": name
    })
    
    # –£–≤–µ–¥–æ–º–∏—Ç—å –≤ Telegram
    await notify_success(
        f"‚úÖ New lead created!\n"
        f"Phone: {phone}\n"
        f"Name: {name}",
        module="LeadService"
    )
    
    return lead
```

---

### –ü—Ä–∏–º–µ—Ä 2: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞—Ä—Å–∏–Ω–≥–∞

```python
# modules/1-market-research/parser.py
from shared.telegram_notifier import telegram_notifier
import time

async def parse_olx(category: str):
    start = time.time()
    
    try:
        ads = await _parse(category)
        elapsed = time.time() - start
        
        # –û—Ç—á–µ—Ç –≤ Telegram
        await telegram_notifier.send_success(
            f"‚úÖ OLX parsing completed!\n"
            f"Category: {category}\n"
            f"Ads found: {len(ads)}\n"
            f"Time: {elapsed:.1f}s",
            module="OLXParser"
        )
        
        return ads
    
    except Exception as e:
        await telegram_notifier.send_error(
            error=e,
            module="OLXParser",
            extra_info={"category": category}
        )
        raise
```

---

### –ü—Ä–∏–º–µ—Ä 3: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ

```python
# core/monitoring/disk_check.py
from shared.telegram_notifier import telegram_notifier

async def check_disk_space():
    usage = get_disk_usage_percent()
    
    if usage > 90:
        await telegram_notifier.send_critical(
            message="Disk space critical!",
            module="SystemMonitor",
            details={
                "disk_usage": f"{usage}%",
                "action": "Clean up or expand disk ASAP"
            }
        )
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

–ë–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã **—Ç–æ–ª—å–∫–æ –æ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** (—Ç–≤–æ–π CHAT_ID).

–ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–π –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞:
```
‚ùå Unauthorized. Only authorized users can use this bot.
```

### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–í `shared/telegram_bot.py` –∏–∑–º–µ–Ω–∏ –ø—Ä–æ–≤–µ—Ä–∫—É:

```python
# –ë—ã–ª–æ:
if str(chat_id) != str(self.chat_id):
    # –û—Ç–∫–ª–æ–Ω–∏—Ç—å

# –°—Ç–∞–ª–æ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏):
authorized_users = [
    os.getenv("TELEGRAM_CHAT_ID"),
    "987654321",  # –î—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    "123456789"   # –ï—â–µ –æ–¥–∏–Ω
]

if str(chat_id) not in authorized_users:
    # –û—Ç–∫–ª–æ–Ω–∏—Ç—å
```

–ò–ª–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
# .env
TELEGRAM_AUTHORIZED_USERS=123456789,987654321,111222333
```

---

## üêõ Troubleshooting

### –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã

**–ü—Ä–æ–≤–µ—Ä—å:**
1. ‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω: `ps aux | grep telegram_bot`
2. ‚úÖ TOKEN –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤ .env
3. ‚úÖ CHAT_ID –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤ .env
4. ‚úÖ –ù–∞–ø–∏—Å–∞–ª –±–æ—Ç—É `/start` –ø–µ—Ä–µ–¥ –∫–æ–º–∞–Ω–¥–∞–º–∏

**–õ–æ–≥–∏:**
```bash
# –ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ nohup
tail -f telegram_bot.log

# –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏ —Å –≤—ã–≤–æ–¥–æ–º
python -m shared.telegram_bot
```

---

### –ö–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç, –Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç

**–ü—Ä–æ–≤–µ—Ä—å:**
1. ‚úÖ `telegram_notifier` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ
2. ‚úÖ –û—à–∏–±–∫–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç
3. ‚úÖ –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –æ—Ç–ø—Ä–∞–≤–∫—É: `grep Telegram logs/`

**–¢–µ—Å—Ç:**
```python
python -c "import asyncio; from shared.telegram_notifier import telegram_notifier; asyncio.run(telegram_notifier.send_success('Test'))"
```

---

### "Unauthorized" –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–∞–Ω–¥

**–ü—Ä–∏—á–∏–Ω–∞:** CHAT_ID –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–π CHAT_ID:
```bash
curl "https://api.telegram.org/bot<TOKEN>/getUpdates"
```

2. –û–±–Ω–æ–≤–∏ .env:
```bash
TELEGRAM_CHAT_ID=–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π_chat_id
```

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–æ—Ç–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å
ps aux | grep telegram_bot

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
tail -f telegram_bot.log

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É
curl -X POST "https://api.telegram.org/bot<TOKEN>/sendMessage" \
  -d "chat_id=<CHAT_ID>&text=/status"
```

---

## üöÄ Production Deployment

### Systemd Service

–°–æ–∑–¥–∞–π `/etc/systemd/system/telegram-bot.service`:

```ini
[Unit]
Description=Lead Generation Telegram Bot
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/lead-generation-system
Environment="PATH=/opt/lead-generation-system/venv/bin"
ExecStart=/opt/lead-generation-system/venv/bin/python -m shared.telegram_bot
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**–ó–∞–ø—É—Å–∫:**
```bash
sudo systemctl enable telegram-bot
sudo systemctl start telegram-bot
sudo systemctl status telegram-bot
```

---

## üìö –§–∞–π–ª—ã

- `shared/telegram_bot.py` - –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –±–æ—Ç–∞
- `shared/telegram_notifier.py` - –º–æ–¥—É–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `scripts/test_telegram_bot.py` - —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
- `scripts/start_telegram_bot.sh` - —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞

---

## ‚úÖ Checklist

- [ ] –ë–æ—Ç —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ @BotFather
- [ ] TOKEN –∏ CHAT_ID –≤ .env
- [ ] –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω: `python -m shared.telegram_bot`
- [ ] –¢–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã: `python scripts/test_telegram_bot.py`
- [ ] –ö–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤ Telegram
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- [ ] Health check —Ä–∞–±–æ—Ç–∞–µ—Ç

---

**–ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å —É —Ç–µ–±—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –±–æ—Ç –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–∏—Å—Ç–µ–º—ã! üöÄ**


