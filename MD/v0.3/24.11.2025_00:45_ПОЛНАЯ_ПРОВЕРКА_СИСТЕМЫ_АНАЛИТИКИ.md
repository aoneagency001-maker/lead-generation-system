# üîç –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 24.11.2025 00:45  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏

### ‚úÖ Google Analytics 4 ‚Äî **–ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–¢–ê–ï–¢**

#### Backend API Endpoints (–≤—Å–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã):

1. **`GET /api/google-analytics/properties`** ‚úÖ
   - **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç
   - **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í–µ—Ä–Ω—É–ª —Å–ø–∏—Å–æ–∫ properties: `[{"id":"439601417","name":"Vessel","property":"properties/439601417"}]`

2. **`GET /api/google-analytics/properties/{id}/visitors-by-date`** ‚úÖ
   - **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç
   - **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–Ω—è–º (sessions, users, pageviews)
   - **–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:**
     ```json
     {
       "data": [
         {"dimensions": ["20251119"], "metrics": [375.0, 342.0, 468.0]},
         {"dimensions": ["20251118"], "metrics": [313.0, 269.0, 438.0]}
       ]
     }
     ```

3. **`GET /api/google-analytics/summary`** ‚úÖ
   - **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç
   - **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–≤–æ–¥–∫–∞ –∑–∞ 7 –¥–Ω–µ–π —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –∏ —Ç–æ–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
   - **–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:**
     ```json
     {
       "property_id": "439601417",
       "metrics": {
         "sessions": 2010,
         "users": 1824,
         "pageviews": 2478,
         "online_users": 9
       },
       "top_sources": [...]
     }
     ```

4. **`GET /api/google-analytics/properties/{id}/traffic-sources`** ‚úÖ
   - **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç
   - **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ (visits, users, bounce_rate)
   - **–ü—Ä–∏–º–µ—Ä:** Yandex Direct, Instagram, Direct traffic

5. **`GET /api/google-analytics/properties/{id}/online-visitors`** ‚úÖ
   - **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç (Real-time API)
   - **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û–Ω–ª–∞–π–Ω –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –º–∏–Ω—É—Ç
   - **–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:**
     ```json
     {
       "data": [
         {"dimensions": ["Kazakhstan", "mobile"], "metrics": [4.0]}
       ],
       "note": "Real-time data (last 30 minutes)"
     }
     ```

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Data Intake Pipeline:

- ‚úÖ **GoogleAnalyticsProvider** (`data_intake/providers/google_analytics.py`)
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ `fetch_visits()`
  - –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è GA4 –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç `VisitEvent`
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYYMMDD
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Service Account –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

---

### ‚ö†Ô∏è –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞ ‚Äî **–¢–†–ï–ë–£–ï–¢ –ù–ê–°–¢–†–û–ô–ö–ò**

#### Backend API Endpoints:

1. **`GET /api/yandex-metrika/counters`** ‚ö†Ô∏è
   - **–°—Ç–∞—Ç—É—Å:** –û—à–∏–±–∫–∞ (Internal server error)
   - **–ü—Ä–∏—á–∏–Ω–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `YANDEX_METRIKA_TOKEN` –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
   - **–û—à–∏–±–∫–∞:** `YANDEX_METRIKA_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω`

#### –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

1. **–ü–æ–ª—É—á–∏—Ç—å OAuth —Ç–æ–∫–µ–Ω –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∏:**
   - –ü–µ—Ä–µ–π—Ç–∏ –≤ [–Ø–Ω–¥–µ–∫—Å OAuth](https://oauth.yandex.ru/)
   - –°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
   - –ü–æ–ª—É—á–∏—Ç—å OAuth —Ç–æ–∫–µ–Ω
   - –î–æ–±–∞–≤–∏—Ç—å –≤ `.env`: `YANDEX_METRIKA_TOKEN=your_token_here`

2. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Counter ID (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
   - –î–æ–±–∞–≤–∏—Ç—å –≤ `.env`: `YANDEX_METRIKA_COUNTER_ID=your_counter_id`

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Data Intake Pipeline:

- ‚úÖ **YandexMetrikaProvider** (`data_intake/providers/yandex_metrika.py`)
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ `fetch_visits()`
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Reporting API (stat/v1/data)
  - –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç `VisitEvent`
  - **–¢—Ä–µ–±—É–µ—Ç:** `YANDEX_METRIKA_TOKEN` –∏ `YANDEX_METRIKA_COUNTER_ID`

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –°–ª–æ–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

1. **API Layer** (`core/api/routes/`)
   - `google_analytics.py` ‚Äî 9 endpoints ‚úÖ
   - `yandex_metrika.py` ‚Äî 10+ endpoints ‚ö†Ô∏è (—Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω)

2. **Client Layer** (`library/integrations/`)
   - `GoogleAnalyticsClient` ‚Äî Service Account –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚úÖ
   - `YandexMetrikaClient` ‚Äî OAuth —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚ö†Ô∏è

3. **Provider Layer** (`data_intake/providers/`)
   - `GoogleAnalyticsProvider` ‚Äî –¥–ª—è ETL pipeline ‚úÖ
   - `YandexMetrikaProvider` ‚Äî –¥–ª—è ETL pipeline ‚ö†Ô∏è

4. **Pipeline Layer** (`data_intake/pipeline.py`)
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ ‚úÖ
   - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ‚úÖ

---

## üìà –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### Google Analytics 4:

- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ Properties
- ‚úÖ –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ –ø–æ –¥–Ω—è–º
- ‚úÖ –°–≤–æ–¥–∫–∞ (summary) –∑–∞ –ø–µ—Ä–∏–æ–¥
- ‚úÖ –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞
- ‚úÖ –û–Ω–ª–∞–π–Ω –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ (real-time)
- ‚úÖ –ì–µ–æ–≥—Ä–∞—Ñ–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
- ‚úÖ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å–µ—â–µ–Ω–∏—è
- ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç endpoint
- ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV/Excel

### –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞ (–∫–æ–¥ –≥–æ—Ç–æ–≤, —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω):

- ‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤ (—Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω)
- ‚ö†Ô∏è –û—Ç—á–µ—Ç—ã –ø–æ —Å—á–µ—Ç—á–∏–∫—É (—Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω)
- ‚ö†Ô∏è –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ –ø–æ –¥–Ω—è–º (—Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω)
- ‚ö†Ô∏è –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ (—Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω)
- ‚ö†Ô∏è –ì–µ–æ–≥—Ä–∞—Ñ–∏—è (—Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω)
- ‚ö†Ô∏è –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV/Excel (—Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω)

---

## üîß –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤

| –°–µ—Ä–≤–∏—Å | –°—Ç–∞—Ç—É—Å | –ü–æ—Ä—Ç | –ü—Ä–æ–≤–µ—Ä–∫–∞ |
|--------|--------|------|----------|
| **Backend API** | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | 8000 | `curl http://localhost:8000/api/health` ‚Üí 200 |
| **Frontend** | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | 3000 | `curl http://localhost:3000` ‚Üí 307 (—Ä–µ–¥–∏—Ä–µ–∫—Ç) |
| **Redis** | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | 6379 | `redis-cli ping` ‚Üí PONG |
| **n8n** | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | 5678 | –ó–∞–ø—É—â–µ–Ω (Node 22) |
| **Metabase** | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | 3030 | `curl http://localhost:3030/api/health` ‚Üí 200 |

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

### Google Analytics 4: **100% –≥–æ—Ç–æ–≤**

- ‚úÖ –í—Å–µ endpoints —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Data Intake Pipeline –≥–æ—Ç–æ–≤–∞
- ‚úÖ Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≥–æ—Ç–æ–≤—ã

### –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞: **90% –≥–æ—Ç–æ–≤ (–∫–æ–¥), 0% (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞)**

- ‚úÖ –í–µ—Å—å –∫–æ–¥ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ –í—Å–µ endpoints —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Data Intake Pipeline –≥–æ—Ç–æ–≤–∞
- ‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç:** OAuth —Ç–æ–∫–µ–Ω –≤ `.env`

---

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –ø–æ–ª–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã:

1. **–î–æ–±–∞–≤–∏—Ç—å –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞ —Ç–æ–∫–µ–Ω:**
   ```bash
   # –í .env —Ñ–∞–π–ª:
   YANDEX_METRIKA_TOKEN=your_oauth_token_here
   YANDEX_METRIKA_COUNTER_ID=your_counter_id  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Google Analytics credentials:**
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `credentials/ga4-service-account.json` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ Service Account –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ Property

3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Data Intake Pipeline:**
   ```bash
   curl -X POST http://localhost:8000/api/data-intake/pipeline/run
   ```

---

## üìù –í—ã–≤–æ–¥—ã

1. **Google Analytics 4** –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
2. **–Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞** –∫–æ–¥ –≥–æ—Ç–æ–≤, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–æ–∫–µ–Ω–∞
3. **Data Intake Pipeline** –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
4. **–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã** –∑–∞–ø—É—â–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –ª–æ–∫–∞–ª—å–Ω–æ
5. **API endpoints** –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ `/docs`

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 24.11.2025 00:45  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞, Google Analytics —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞ —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω**

