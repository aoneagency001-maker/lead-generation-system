# ‚úÖ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Ç–æ–∫–µ–Ω–æ–≤ –∏ –¥–æ—Å—Ç—É–ø–æ–≤

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 24.11.2025 01:00  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–í–°–ï –¢–û–ö–ï–ù–´ –†–ê–ë–û–¢–ê–Æ–¢**

---

## üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤

### ‚úÖ –í—Å–µ —Ç–æ–∫–µ–Ω—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏ –≤–∞–ª–∏–¥–Ω—ã:

| –¢–æ–∫–µ–Ω/–î–æ—Å—Ç—É–ø | –°—Ç–∞—Ç—É—Å | –î–µ—Ç–∞–ª–∏ |
|--------------|--------|--------|
| **YANDEX_METRIKA_TOKEN** | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –î–ª–∏–Ω–∞: 53 —Å–∏–º–≤–æ–ª–∞, API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 OK |
| **YANDEX_METRIKA_COUNTER_ID** | ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω | ID: 94052393 (vesselgroup.kz) |
| **GOOGLE_ANALYTICS_CREDENTIALS_PATH** | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: `credentials/ga4-service-account.json` (2374 –±–∞–π—Ç) |
| **GOOGLE_ANALYTICS_PROPERTY_ID** | ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω | ID: 439601417 (Vessel) |
| **SUPABASE_URL** | ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω | `https://upgowxrbwjgyoqbjcegc.supabase.co` |
| **SUPABASE_KEY** | ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω | –î–ª–∏–Ω–∞: 208 —Å–∏–º–≤–æ–ª–æ–≤ |

---

## üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API Endpoints

### ‚úÖ –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞ ‚Äî **–ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–¢–ê–ï–¢**

#### 1. `GET /api/yandex-metrika/counters` ‚úÖ
- **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í–µ—Ä–Ω—É–ª —Å–ø–∏—Å–æ–∫ –∏–∑ **9 —Å—á–µ—Ç—á–∏–∫–æ–≤**
- **–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:**
  ```json
  {
    "counters": [
      {
        "id": 62034082,
        "name": "A One Agency",
        "site": "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ.kz",
        "status": "Active"
      },
      {
        "id": 94052393,
        "name": "vesselgroup",
        "site": "vesselgroup.kz",
        "status": "Active"
      },
      ...
    ]
  }
  ```

#### 2. `GET /api/yandex-metrika/counters/{id}/summary` ‚úÖ
- **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:** Counter ID 94052393, –ø–µ—Ä–∏–æ–¥ 7 –¥–Ω–µ–π

#### 3. `GET /api/yandex-metrika/counters/{id}/visitors-by-date` ‚úÖ
- **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:** Counter ID 94052393, –ø–µ—Ä–∏–æ–¥ 7 –¥–Ω–µ–π

---

### ‚úÖ Google Analytics 4 ‚Äî **–ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–¢–ê–ï–¢**

#### 1. `GET /api/google-analytics/properties` ‚úÖ
- **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í–µ—Ä–Ω—É–ª Property: `{"id":"439601417","name":"Vessel"}`

#### 2. `GET /api/google-analytics/summary` ‚úÖ
- **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–≤–æ–¥–∫–∞ –∑–∞ 7 –¥–Ω–µ–π —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏

#### 3. `GET /api/google-analytics/properties/{id}/visitors-by-date` ‚úÖ
- **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –î–∞–Ω–Ω—ã–µ –ø–æ –¥–Ω—è–º (sessions, users, pageviews)

#### 4. `GET /api/google-analytics/properties/{id}/traffic-sources` ‚úÖ
- **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ (Yandex Direct, Instagram, Direct)

#### 5. `GET /api/google-analytics/properties/{id}/online-visitors` ‚úÖ
- **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç (Real-time API)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û–Ω–ª–∞–π–Ω –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –º–∏–Ω—É—Ç

---

## üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏

### –ü—Ä–æ–±–ª–µ–º–∞: `NameError: name 'cache_key_str' is not defined`

**–§–∞–π–ª:** `core/api/routes/yandex_metrika.py` (—Å—Ç—Ä–æ–∫–∞ 113)

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `cache_key_str` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –¥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º –∫ API:
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à (1 —á–∞—Å –¥–ª—è —Å–ø–∏—Å–∫–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤)
cache_key_str = cache_key("ym", "counters")
cached = await get_cached(cache_key_str)
if cached:
    logger.info("‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∫—ç—à –¥–ª—è —Å–ø–∏—Å–∫–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤")
    return cached
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ Endpoint `/api/yandex-metrika/counters` —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üìã –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤ –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∏

1. **62034082** - A One Agency (–∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ.kz)
2. **90043896** - moneyfest (moneyfest-for.me)
3. **94052393** - vesselgroup (vesselgroup.kz) ‚≠ê **–û—Å–Ω–æ–≤–Ω–æ–π**
4. **104784359** - VesselRoof (Vesselroof.kz)
5. **89906875** - –ê–∫–∞–¥–µ–º–∏—è (auction-academy.kz)
6. **92556369** - –°—Ö–µ–º—ã –ª–µ–Ω–¥ (mzuojp.iuldrd.shop)
7. **101117125** - –¢–µ—Å—Ç PerFormante (ai-target-swift-flow.lovable.app)
8. **64613791** - A-One Agency - –ø—Ä–æ—Å–ø–µ–∫—Ç –ù–∞–∑–∞—Ä–±–∞–µ–≤–∞, 103 (yandex.ru/maps)
9. **86759813** - BORD (bord-lux.kz)

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

### –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞: **100% –≥–æ—Ç–æ–≤** ‚úÖ
- ‚úÖ –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –í—Å–µ endpoints —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç
- ‚úÖ –ü–æ–ª—É—á–µ–Ω—ã —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (9 —Å—á–µ—Ç—á–∏–∫–æ–≤)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Data Intake Pipeline –≥–æ—Ç–æ–≤–∞

### Google Analytics 4: **100% –≥–æ—Ç–æ–≤** ‚úÖ
- ‚úÖ Service Account credentials —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –í—Å–µ endpoints —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç
- ‚úÖ –ü–æ–ª—É—á–µ–Ω—ã —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ Real-time API —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Data Intake Pipeline –≥–æ—Ç–æ–≤–∞

---

## üöÄ –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ

–í—Å–µ —Ç–æ–∫–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã, –≤—Å–µ endpoints –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã, –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. ‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
2. ‚úÖ –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å Data Intake Pipeline –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
3. ‚úÖ –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Unified Analytics –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö GA4 + –ú–µ—Ç—Ä–∏–∫–∞

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 24.11.2025 01:00  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–í–°–ï –¢–û–ö–ï–ù–´ –†–ê–ë–û–¢–ê–Æ–¢, –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê**

