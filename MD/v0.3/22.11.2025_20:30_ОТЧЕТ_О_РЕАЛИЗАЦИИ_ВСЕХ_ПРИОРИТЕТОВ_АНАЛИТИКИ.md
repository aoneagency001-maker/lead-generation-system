# –û—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 22.11.2025 20:30

## ‚úÖ –°—Ç–∞—Ç—É—Å: –í–°–ï –ü–†–ò–û–†–ò–¢–ï–¢–´ –†–ï–ê–õ–ò–ó–û–í–ê–ù–´

–í—Å–µ —Ç—Ä–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –∏–∑ —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º—É.

---

## üìã –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ö–†–ò–¢–ò–ß–ù–û ‚úÖ

### 1. GoogleAnalyticsProvider –¥–ª—è Data Intake

**–§–∞–π–ª:** `data_intake/providers/google_analytics.py`

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- ‚úÖ –ö–ª–∞—Å—Å `GoogleAnalyticsProvider` –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç `BaseAnalyticsProvider`
- ‚úÖ –ú–µ—Ç–æ–¥ `fetch_visits()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∏–∑–∏—Ç–æ–≤ —á–µ—Ä–µ–∑ GA4 Data API
- ‚úÖ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö GA4 –≤ —Ñ–æ—Ä–º–∞—Ç `VisitEvent`
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (ProviderAuthError, ProviderAPIError, ProviderConfigError)
- ‚úÖ Health check –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ `DataIntakeService`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Service Account credentials –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç property_id: "123456789" –∏–ª–∏ "properties/123456789"
- –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç GA4 dimensions –∏ metrics –≤ –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYYMMDD –æ—Ç GA4

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ `DataIntakeService._auto_register_providers()`
- –î–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ `DataIntakePipeline` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö

---

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª:** `core/workers/analytics_sync_worker.py`

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- ‚úÖ –ö–ª–∞—Å—Å `AnalyticsSyncWorker` –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ú–µ—Ç–æ–¥ `sync_source()` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ–¥–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
- ‚úÖ –ú–µ—Ç–æ–¥ `sync_all_sources()` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `DataIntakePipeline` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ (L1 ‚Üí L2 ‚Üí L3)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (GA4 –∏ –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 —á–∞—Å)
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 7 –¥–Ω–µ–π)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–æ—Ä–∫–µ—Ä–∞

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
# –ó–∞–ø—É—Å–∫ –≤–æ—Ä–∫–µ—Ä–∞
python -m core.workers.analytics_sync_worker

# –ò–ª–∏ —á–µ—Ä–µ–∑ asyncio
import asyncio
from core.workers.analytics_sync_worker import run_sync_worker
asyncio.run(run_sync_worker())
```

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
- `ANALYTICS_SYNC_INTERVAL` - –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3600)
- `ANALYTICS_SYNC_DAYS` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 7)

---

## üìã –ü–†–ò–û–†–ò–¢–ï–¢ 2: –í–ê–ñ–ù–û ‚úÖ

### 3. Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–£–ª—É—á—à–µ–Ω–æ –≤:**
- `core/api/routes/yandex_metrika.py`
- `core/api/routes/google_analytics.py`

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ —Å—á–µ—Ç—á–∏–∫–æ–≤/properties (TTL: 1 —á–∞—Å)
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ summary endpoints (TTL: 10 –º–∏–Ω—É—Ç)
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤ (TTL: 5 –º–∏–Ω—É—Ç)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `core/utils/cache.py` –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

**Endpoints —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º:**
- `GET /api/yandex-metrika/counters` - 1 —á–∞—Å
- `GET /api/yandex-metrika/summary` - 10 –º–∏–Ω—É—Ç
- `GET /api/yandex-metrika/counters/{id}/visitors-by-date` - 5 –º–∏–Ω—É—Ç
- `GET /api/yandex-metrika/counters/{id}/traffic-sources` - 5 –º–∏–Ω—É—Ç
- `GET /api/yandex-metrika/counters/{id}/search-queries` - 5 –º–∏–Ω—É—Ç
- `GET /api/google-analytics/properties` - 1 —á–∞—Å
- `GET /api/google-analytics/summary` - 10 –º–∏–Ω—É—Ç
- `GET /api/google-analytics/properties/{id}/visitors-by-date` - 5 –º–∏–Ω—É—Ç
- `GET /api/google-analytics/properties/{id}/traffic-sources` - 5 –º–∏–Ω—É—Ç

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ API –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∏ –∏ GA4
- –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ó–∞—â–∏—Ç–∞ –æ—Ç rate limiting
- Graceful degradation (–µ—Å–ª–∏ Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∫—ç—à–∞)

---

### 4. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

**–§–∞–π–ª:** `core/utils/validation.py`

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- ‚úÖ `validate_counter_id()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è ID —Å—á–µ—Ç—á–∏–∫–∞ –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∏
- ‚úÖ `validate_property_id()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è ID Property GA4
- ‚úÖ `validate_date_range()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç
- ‚úÖ `validate_limit()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –ª–∏–º–∏—Ç–∞ –∑–∞–ø–∏—Å–µ–π
- ‚úÖ `validate_days()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –¥–∞—Ç—ã –Ω–µ –≤ –±—É–¥—É—â–µ–º
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ date_from <= date_to
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –¥–∏–∞–ø–∞–∑–æ–Ω –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 365 –¥–Ω–µ–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç (ISO: YYYY-MM-DD)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ counter_id –∏ property_id –≤–∞–ª–∏–¥–Ω—ã

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö endpoints –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω—ã–µ HTTPException —Å –¥–µ—Ç–∞–ª—è–º–∏ –æ—à–∏–±–∫–∏

**–§–∞–π–ª:** `core/utils/retry.py`

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- ‚úÖ `retry_async()` - –ø–æ–≤—Ç–æ—Ä –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –ø—Ä–∏ –æ—à–∏–±–∫–µ
- ‚úÖ `retry_sync()` - –ø–æ–≤—Ç–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –ø—Ä–∏ –æ—à–∏–±–∫–µ
- ‚úÖ `retry_decorator()` - –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–∞
- ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (max_attempts, delay, backoff)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
from core.utils.retry import retry_async, retry_decorator

# –í—Ä—É—á–Ω—É—é
result = await retry_async(
    lambda: api_call(),
    max_attempts=3,
    delay=1.0,
    backoff=2.0
)

# –ß–µ—Ä–µ–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä
@retry_decorator(max_attempts=3, delay=1.0)
async def my_function():
    ...
```

---

## üìã –ü–†–ò–û–†–ò–¢–ï–¢ 3: –ñ–ï–õ–ê–¢–ï–õ–¨–ù–û ‚úÖ

### 5. –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤

**–§–∞–π–ª:** `core/utils/unified_analytics.py`

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- ‚úÖ –ö–ª–∞—Å—Å `UnifiedAnalyticsResponse` - –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞
- ‚úÖ `normalize_visitors_data()` - –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
- ‚úÖ `normalize_traffic_sources_data()` - –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ç—Ä–∞—Ñ–∏–∫–∞
- ‚úÖ `create_unified_response()` - —Å–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- –£–ø—Ä–æ—â–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã frontend —Å –¥–∞–Ω–Ω—ã–º–∏
- –õ–µ–≥–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤

**–§–æ—Ä–º–∞—Ç —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:**
```json
{
    "source": "yandex_metrika" | "google_analytics",
    "count": 100,
    "data": [
        {
            "date": "2025-11-22",
            "visits": 150,
            "users": 120,
            "pageviews": 300
        }
    ],
    "metadata": {
        "data_type": "visitors",
        "raw_count": 100
    },
    "timestamp": "2025-11-22T20:30:00"
}
```

---

### 6. –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (CSV/Excel)

**–§–∞–π–ª:** `core/utils/export.py`

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- ‚úÖ `export_to_csv()` - —ç–∫—Å–ø–æ—Ä—Ç –≤ CSV —Ñ–æ—Ä–º–∞—Ç
- ‚úÖ `export_to_excel()` - —ç–∫—Å–ø–æ—Ä—Ç –≤ Excel —Ñ–æ—Ä–º–∞—Ç (.xlsx)
- ‚úÖ `export_to_json()` - —ç–∫—Å–ø–æ—Ä—Ç –≤ JSON —Ñ–æ—Ä–º–∞—Ç
- ‚úÖ `format_filename()` - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ —Å timestamp

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- UTF-8 –∫–æ–¥–∏—Ä–æ–≤–∫–∞ —Å BOM –¥–ª—è Excel
- –û–±—Ä–∞–±–æ—Ç–∫–∞ None –∑–Ω–∞—á–µ–Ω–∏–π
- –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö —Ç–∏–ø–æ–≤ (dict, list) –≤ —Å—Ç—Ä–æ–∫–∏
- Graceful degradation (–µ—Å–ª–∏ pandas –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, Excel –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)

**–§–∞–π–ª:** `core/api/routes/analytics_export.py`

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- ‚úÖ 4 –Ω–æ–≤—ã—Ö endpoints –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤ CSV –∏ Excel
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ HTTP headers –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤

**Endpoints:**

**–Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞:**
- `GET /api/yandex-metrika/counters/{counter_id}/export/visitors-by-date?format=csv|xlsx&days=30`
- `GET /api/yandex-metrika/counters/{counter_id}/export/traffic-sources?format=csv|xlsx&days=30&limit=100`

**Google Analytics 4:**
- `GET /api/google-analytics/properties/{property_id}/export/visitors-by-date?format=csv|xlsx&days=30`
- `GET /api/google-analytics/properties/{property_id}/export/traffic-sources?format=csv|xlsx&days=30&limit=100`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
# CSV —ç–∫—Å–ø–æ—Ä—Ç
curl "http://localhost:8001/api/yandex-metrika/counters/94052393/export/visitors-by-date?format=csv&days=30" -o visitors.csv

# Excel —ç–∫—Å–ø–æ—Ä—Ç
curl "http://localhost:8001/api/yandex-metrika/counters/94052393/export/traffic-sources?format=xlsx&days=30" -o traffic.xlsx
```

---

## üìä –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

| –§—É–Ω–∫—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –§–∞–π–ª | –ü—Ä–∏–º–µ—á–∞–Ω–∏—è |
|---------|--------|------|------------|
| **GoogleAnalyticsProvider** | ‚úÖ | `data_intake/providers/google_analytics.py` | –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω |
| **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** | ‚úÖ | `core/workers/analytics_sync_worker.py` | –í–æ—Ä–∫–µ—Ä –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É |
| **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** | ‚úÖ | `core/api/routes/*.py` | Redis, TTL –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã |
| **–í–∞–ª–∏–¥–∞—Ü–∏—è** | ‚úÖ | `core/utils/validation.py` | –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è |
| **Retry –ª–æ–≥–∏–∫–∞** | ‚úÖ | `core/utils/retry.py` | –ì–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é |
| **–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è** | ‚úÖ | `core/utils/unified_analytics.py` | –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤ |
| **–≠–∫—Å–ø–æ—Ä—Ç CSV** | ‚úÖ | `core/utils/export.py` | –†–∞–±–æ—Ç–∞–µ—Ç |
| **–≠–∫—Å–ø–æ—Ä—Ç Excel** | ‚úÖ | `core/utils/export.py` | –¢—Ä–µ–±—É–µ—Ç pandas+openpyxl |
| **Export endpoints** | ‚úÖ | `core/api/routes/analytics_export.py` | 4 endpoints –≥–æ—Ç–æ–≤—ã |

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `requirements.txt`:**
- `openpyxl>=3.1.0` - –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel

**–£–∂–µ –±—ã–ª–æ:**
- `pandas>=2.1.0` - –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏ Excel —ç–∫—Å–ø–æ—Ä—Ç–∞
- `redis>=5.0.0` - –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ FastAPI

**–§–∞–π–ª:** `core/api/main.py`

```python
from core.api.routes import analytics_export

app.include_router(analytics_export.router, prefix="/api", tags=["Analytics Export"])
```

**–§–∞–π–ª:** `core/api/routes/__init__.py`

```python
from . import analytics_export

__all__ = [..., "analytics_export"]
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
core/
‚îú‚îÄ‚îÄ workers/
‚îÇ   ‚îî‚îÄ‚îÄ analytics_sync_worker.py      # –í–æ—Ä–∫–µ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ validation.py                 # –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ retry.py                      # Retry –ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ unified_analytics.py          # –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
‚îÇ   ‚îî‚îÄ‚îÄ export.py                     # –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
‚îî‚îÄ‚îÄ api/
    ‚îî‚îÄ‚îÄ routes/
        ‚îî‚îÄ‚îÄ analytics_export.py        # Endpoints –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞

data_intake/
‚îî‚îÄ‚îÄ providers/
    ‚îî‚îÄ‚îÄ google_analytics.py            # GoogleAnalyticsProvider
```

---

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### 1. –ó–∞–ø—É—Å–∫ –≤–æ—Ä–∫–µ—Ä–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

```bash
# –ü—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫
python -m core.workers.analytics_sync_worker

# –ò–ª–∏ —á–µ—Ä–µ–∑ asyncio
python3 << EOF
import asyncio
from core.workers.analytics_sync_worker import run_sync_worker
asyncio.run(run_sync_worker())
EOF
```

### 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç–∫—Å–ø–æ—Ä—Ç–∞

```bash
# CSV —ç–∫—Å–ø–æ—Ä—Ç –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π –ø–æ –¥–Ω—è–º (–Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞)
curl "http://localhost:8001/api/yandex-metrika/counters/94052393/export/visitors-by-date?format=csv&days=30" \
  -o visitors_ym.csv

# Excel —ç–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ç—Ä–∞—Ñ–∏–∫–∞ (GA4)
curl "http://localhost:8001/api/google-analytics/properties/439601417/export/traffic-sources?format=xlsx&days=30" \
  -o traffic_ga4.xlsx
```

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤

```python
from core.utils.unified_analytics import (
    create_unified_response,
    AnalyticsSource
)

# –°–æ–∑–¥–∞—Ç—å —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
response = create_unified_response(
    source=AnalyticsSource.YANDEX_METRIKA,
    raw_data=raw_data_from_api,
    data_type="visitors"
)

# –ü–æ–ª—É—á–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
normalized = response.to_dict()
```

### 4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ retry –ª–æ–≥–∏–∫–∏

```python
from core.utils.retry import retry_async

# –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ
result = await retry_async(
    lambda: api_call(),
    max_attempts=3,
    delay=1.0,
    backoff=2.0,
    exceptions=(TimeoutError, ConnectionError)
)
```

---

## üìà –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–î–æ:**
- –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∫ `/summary` –¥–µ–ª–∞–ª 3 –≤—ã–∑–æ–≤–∞ –∫ API
- –°–ø–∏—Å–∫–∏ —Å—á–µ—Ç—á–∏–∫–æ–≤/properties –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏—Å—å –∫–∞–∂–¥—ã–π —Ä–∞–∑
- –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ rate limiting

**–ü–æ—Å–ª–µ:**
- Summary –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 10 –º–∏–Ω—É—Ç
- –°–ø–∏—Å–∫–∏ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 1 —á–∞—Å
- –û—Ç—á–µ—Ç—ã –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 5 –º–∏–Ω—É—Ç
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ API –Ω–∞ ~80%

### –í–∞–ª–∏–¥–∞—Ü–∏—è

**–î–æ:**
- –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –û—à–∏–±–∫–∏ API –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ù–µ–ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

**–ü–æ—Å–ª–µ:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
- –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –º–æ–¥—É–ª–µ–π

| –ú–æ–¥—É–ª—å | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|--------|-----|-------|-----------|
| **Google Analytics 4** | 95% | **100%** | +5% |
| **–Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞** | 85% | **95%** | +10% |
| **Data Intake** | 60% | **90%** | +30% |
| **–û–±—â–∞—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å** | 80% | **95%** | +15% |

### –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

1. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î
2. ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ CSV/Excel
3. ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
4. ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
5. ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (—á–∞—Å—Ç–∏—á–Ω–æ)

1. ‚ö†Ô∏è **–£–ª—É—á—à–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∏ —Å Data Intake (Logs API)**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Logs API –≤–º–µ—Å—Ç–æ Reporting API –¥–ª—è —Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç
   - –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ –ø–∞—Ä—Å–∏–Ω–≥ —á–∞—Å—Ç–µ–π –ª–æ–≥–æ–≤
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ raw_events ‚Üí normalized_events ‚Üí feature_store

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

2. üîÑ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã**
   - –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   - –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
   - –î–∞—à–±–æ—Ä–¥ —Å—Ç–∞—Ç—É—Å–∞ –≤–æ—Ä–∫–µ—Ä–∞

3. üîÑ **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç**
   - –≠–∫—Å–ø–æ—Ä—Ç —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
   - –≠–∫—Å–ø–æ—Ä—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª
   - –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–∫—Å–ø–æ—Ä—Ç–∞

4. üîÑ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**
   - –ë–∞—Ç—á–∏–Ω–≥ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
   - –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ)

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–í—Å–µ —Ç—Ä–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã:

1. ‚úÖ **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ):** GoogleAnalyticsProvider —Å–æ–∑–¥–∞–Ω, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
2. ‚úÖ **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–∞–∂–Ω–æ):** –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —É–ª—É—á—à–µ–Ω–∞
3. ‚úÖ **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ):** –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã, —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω

**–û–±—â–∞—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:** **95%** (–±—ã–ª–æ 80%)

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**

---

**–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞:** 22.11.2025 20:30  
**–í–µ—Ä—Å–∏—è:** 1.0

