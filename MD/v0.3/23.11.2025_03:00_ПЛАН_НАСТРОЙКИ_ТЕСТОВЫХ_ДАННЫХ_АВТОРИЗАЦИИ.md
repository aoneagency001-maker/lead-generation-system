# üîê –ü–ª–∞–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 23.11.2025 03:00

## üìã –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞
- –í —Å–ø–∏—Å–∫–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ Data Intake —Ç–æ–ª—å–∫–æ YANDEX_METRIKA (–∏–ª–∏ –≤–æ–æ–±—â–µ –ø—É—Å—Ç–æ)
- –û—à–∏–±–∫–∞ "Provider not available" –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ pipeline
- –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –¢—Ä–µ–±—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

#### –î–ª—è Yandex.Metrika:
```bash
YANDEX_METRIKA_TOKEN=y0__xDRn5OABBir2zsgqO_EnxUezT_ln_UKWnGz2duHNjE8tQQzfA
YANDEX_METRIKA_COUNTER_ID=94052393  # –ò–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: vesselgroup.kz
```

#### –î–ª—è Google Analytics 4:
```bash
GOOGLE_ANALYTICS_CREDENTIALS_PATH=credentials/ga4-service-account.json
GOOGLE_ANALYTICS_PROPERTY_ID=439601417  # –ò–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: Vessel Property
```

**‚úÖ –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è —É–∂–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `.env` —Ñ–∞–π–ª.

---

## üéØ –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Yandex.Metrika

#### 1.1 –°–æ–∑–¥–∞–Ω–∏–µ OAuth –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –Ø–Ω–¥–µ–∫—Å

**–°—Å—ã–ª–∫–∞:** https://oauth.yandex.ru/

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –í–æ–π—Ç–∏ –≤ –Ø–Ω–¥–µ–∫—Å –∞–∫–∫–∞—É–Ω—Ç
2. –ü–µ—Ä–µ–π—Ç–∏ –≤ "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º" ‚Üí "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
3. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ OAuth –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
4. –ü–æ–ª—É—á–∏—Ç—å Client ID –∏ Client Secret
5. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å redirect URI (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `http://localhost:8001/oauth/callback`)

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** https://yandex.ru/dev/id/doc/ru/

#### 1.2 –ü–æ–ª—É—á–µ–Ω–∏–µ OAuth —Ç–æ–∫–µ–Ω–∞

**–í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ OAuth Flow (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)**
```bash
# 1. –ü–æ–ª—É—á–∏—Ç—å authorization code
# –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
https://oauth.yandex.ru/authorize?response_type=code&client_id=<CLIENT_ID>&redirect_uri=http://localhost:8001/oauth/callback

# 2. –û–±–º–µ–Ω—è—Ç—å code –Ω–∞ token
curl -X POST https://oauth.yandex.ru/token \
  -d "grant_type=authorization_code" \
  -d "code=<CODE>" \
  -d "client_id=<CLIENT_ID>" \
  -d "client_secret=<CLIENT_SECRET>"
```

**–í–∞—Ä–∏–∞–Ω—Ç B: –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–±)**
```bash
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
# –¢—Ä–µ–±—É–µ—Ç—Å—è: –¥–æ—Å—Ç—É–ø –∫ –∞–∫–∫–∞—É–Ω—Ç—É —Å –ú–µ—Ç—Ä–∏–∫–æ–π
```

#### 1.3 –ü–æ–ª—É—á–µ–Ω–∏–µ Counter ID

**–°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**
1. –ó–∞–π—Ç–∏ –≤ https://metrika.yandex.ru/
2. –í—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—ã–π —Å—á–µ—Ç—á–∏–∫
3. Counter ID –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ URL: `https://metrika.yandex.ru/dashboard?id=<COUNTER_ID>`

**–°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ API (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω)**
```bash
curl -H "Authorization: OAuth <TOKEN>" \
  https://api-metrika.yandex.net/management/v1/counters
```

#### 1.4 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ .env

```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ .env —Ñ–∞–π–ª:
YANDEX_METRIKA_TOKEN=your_oauth_token_here
YANDEX_METRIKA_COUNTER_ID=your_counter_id_here
```

---

### –®–∞–≥ 2: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Google Analytics 4

#### 2.1 –°–æ–∑–¥–∞–Ω–∏–µ Service Account

**–°—Å—ã–ª–∫–∞:** https://console.cloud.google.com/

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –í–æ–π—Ç–∏ –≤ Google Cloud Console
2. –í—ã–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç (–∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π)
3. –ü–µ—Ä–µ–π—Ç–∏ –≤ "IAM & Admin" ‚Üí "Service Accounts"
4. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π Service Account:
   - Name: `ga4-data-intake`
   - Description: `Service account for Data Intake pipeline`
5. –°–æ–∑–¥–∞—Ç—å –∫–ª—é—á (JSON):
   - –ù–∞–∂–∞—Ç—å –Ω–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã–π Service Account
   - –ü–µ—Ä–µ–π—Ç–∏ –≤ "Keys" ‚Üí "Add Key" ‚Üí "Create new key"
   - –í—ã–±—Ä–∞—Ç—å JSON —Ñ–æ—Ä–º–∞—Ç
   - –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª

#### 2.2 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ GA4 Property

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ü–µ—Ä–µ–π—Ç–∏ –≤ Google Analytics 4: https://analytics.google.com/
2. –í—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—ã–π Property
3. –ü–µ—Ä–µ–π—Ç–∏ –≤ "Admin" ‚Üí "Property Access Management"
4. –î–æ–±–∞–≤–∏—Ç—å Service Account email (–∏–∑ JSON —Ñ–∞–π–ª–∞)
5. –ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å: **"Viewer"** (–º–∏–Ω–∏–º—É–º) –∏–ª–∏ **"Analyst"** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–í–∞–∂–Ω–æ:** Service Account –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø –∫ Property, –∏–Ω–∞—á–µ API –≤–µ—Ä–Ω–µ—Ç 403.

#### 2.3 –ü–æ–ª—É—á–µ–Ω–∏–µ Property ID

**–°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**
1. –ó–∞–π—Ç–∏ –≤ GA4 Property
2. –ü–µ—Ä–µ–π—Ç–∏ –≤ "Admin" ‚Üí "Property Settings"
3. Property ID –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "Property Details"

**–°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ API (–µ—Å–ª–∏ –µ—Å—Ç—å credentials)**
```bash
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Google Analytics Admin API
# Property ID –æ–±—ã—á–Ω–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: "123456789"
```

#### 2.4 –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ credentials —Ñ–∞–π–ª–∞

```bash
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON —Ñ–∞–π–ª –≤ –ø—Ä–æ–µ–∫—Ç:
cp ~/Downloads/ga4-service-account-*.json credentials/ga4-service-account.json

# –ò–ª–∏ —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç:
mkdir -p credentials
mv ~/Downloads/ga4-service-account-*.json credentials/ga4-service-account.json
```

#### 2.5 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ .env

```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ .env —Ñ–∞–π–ª:
GOOGLE_ANALYTICS_CREDENTIALS_PATH=credentials/ga4-service-account.json
GOOGLE_ANALYTICS_PROPERTY_ID=your_property_id_here
```

---

### –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .env.example

–î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ `.env.example` –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:

```bash
# Yandex.Metrika
YANDEX_METRIKA_TOKEN=your_oauth_token_here
YANDEX_METRIKA_COUNTER_ID=your_counter_id_here

# Google Analytics 4
GOOGLE_ANALYTICS_CREDENTIALS_PATH=credentials/ga4-service-account.json
GOOGLE_ANALYTICS_PROPERTY_ID=your_property_id_here
```

---

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

#### 4.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:
python3 -c "
import os
from dotenv import load_dotenv
load_dotenv()
print('YANDEX_METRIKA_TOKEN:', 'SET' if os.getenv('YANDEX_METRIKA_TOKEN') else 'NOT SET')
print('YANDEX_METRIKA_COUNTER_ID:', 'SET' if os.getenv('YANDEX_METRIKA_COUNTER_ID') else 'NOT SET')
print('GOOGLE_ANALYTICS_CREDENTIALS_PATH:', os.getenv('GOOGLE_ANALYTICS_CREDENTIALS_PATH') or 'NOT SET')
print('GOOGLE_ANALYTICS_PROPERTY_ID:', 'SET' if os.getenv('GOOGLE_ANALYTICS_PROPERTY_ID') else 'NOT SET')
"
```

#### 4.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ health endpoint

```bash
# –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ backend:
curl http://localhost:8001/api/data-intake/health

# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å:
# {
#   "status": "healthy" –∏–ª–∏ "degraded",
#   "sources": {
#     "YANDEX_METRIKA": true/false,
#     "GOOGLE_ANALYTICS": true/false
#   }
# }
```

#### 4.3 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–∏—Å–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

```bash
curl http://localhost:8001/api/data-intake/sources

# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å:
# {
#   "sources": ["YANDEX_METRIKA", "GOOGLE_ANALYTICS"],
#   "count": 2
# }
```

---

## üîß –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞ 1: "Provider not available for YANDEX_METRIKA"

**–ü—Ä–∏—á–∏–Ω—ã:**
- `YANDEX_METRIKA_TOKEN` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- `YANDEX_METRIKA_COUNTER_ID` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –∏–ª–∏ –∏—Å—Ç–µ–∫

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ `.env`
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ API:
   ```bash
   curl -H "Authorization: OAuth <TOKEN>" \
     https://api-metrika.yandex.net/management/v1/counters
   ```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: "Provider not available for GOOGLE_ANALYTICS"

**–ü—Ä–∏—á–∏–Ω—ã:**
- `GOOGLE_ANALYTICS_CREDENTIALS_PATH` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- –§–∞–π–ª credentials –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- `GOOGLE_ANALYTICS_PROPERTY_ID` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- Service Account –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Property

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—É—Ç—å –∫ credentials —Ñ–∞–π–ª—É
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —á–∏—Ç–∞–µ—Ç—Å—è
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Property ID
4. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ Service Account –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –≤ GA4

### –ü—Ä–æ–±–ª–µ–º–∞ 3: "Authentication failed"

**–î–ª—è Yandex.Metrika:**
- –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ (OAuth —Ç–æ–∫–µ–Ω—ã –∏–º–µ—é—Ç —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è)
- –¢–æ–∫–µ–Ω –Ω–µ –∏–º–µ–µ—Ç –Ω—É–∂–Ω—ã—Ö –ø—Ä–∞–≤ (–Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –ú–µ—Ç—Ä–∏–∫–µ)

**–î–ª—è Google Analytics:**
- Service Account –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Property
- Credentials —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω
- Property ID –Ω–µ–≤–µ—Ä–Ω—ã–π

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ç–æ–∫–µ–Ω/credentials
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ backend –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –æ—à–∏–±–∫–∏

---

## üìù –ß–µ–∫–ª–∏—Å—Ç

- [ ] –°–æ–∑–¥–∞–Ω–æ OAuth –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –Ø–Ω–¥–µ–∫—Å
- [ ] –ü–æ–ª—É—á–µ–Ω OAuth —Ç–æ–∫–µ–Ω –¥–ª—è Yandex.Metrika
- [ ] –ü–æ–ª—É—á–µ–Ω Counter ID
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ YANDEX_METRIKA_* –≤ .env
- [ ] –°–æ–∑–¥–∞–Ω Service Account –≤ Google Cloud
- [ ] –°–∫–∞—á–∞–Ω JSON –∫–ª—é—á –¥–ª—è Service Account
- [ ] Service Account –¥–æ–±–∞–≤–ª–µ–Ω –≤ GA4 Property —Å –ø—Ä–∞–≤–∞–º–∏
- [ ] –ü–æ–ª—É—á–µ–Ω Property ID
- [ ] Credentials —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ `credentials/ga4-service-account.json`
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ GOOGLE_ANALYTICS_* –≤ .env
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω .env.example
- [ ] –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω backend
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω health endpoint
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –∑–∞–ø—É—Å–∫ pipeline

---

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

### Yandex.Metrika
- OAuth: https://oauth.yandex.ru/
- API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://yandex.ru/dev/metrika/doc/api2/api_v1/intro.html
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏: https://oauth.yandex.ru/client/new

### Google Analytics 4
- Google Cloud Console: https://console.cloud.google.com/
- GA4 Admin: https://analytics.google.com/
- GA4 Data API: https://developers.google.com/analytics/devguides/reporting/data/v1
- Service Accounts: https://cloud.google.com/iam/docs/service-accounts

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 23.11.2025 03:00

