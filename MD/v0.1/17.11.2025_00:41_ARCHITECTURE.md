# üèóÔ∏è Lead Generation System - Architecture

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 17.11.2025 00:41


## Overview

This document describes the architectural decisions, patterns, and principles used in the Lead Generation System.

---

## üéØ Core Philosophy

### Military-Grade Modularity
Inspired by Napoleon's and Genghis Khan's army structures:
- **Independent Units** - Each module can operate standalone
- **Replaceable Components** - Swap modules without affecting others
- **Clear Command Structure** - Orchestrator (crewAI) coordinates all modules
- **Rapid Deployment** - Quick testing and iteration on new niches

### Kadyrov's Business Logic
Based on content factory methodology:
1. **IKR (Ideal Final Result)** - Clear metrics for success (CPL, ROI)
2. **Process Stages** - Each module represents a stage in the pipeline
3. **Unit Responsibility** - Each module has clear ownership
4. **Project Board** - n8n provides visual workflow management
5. **Standards** - Pydantic models enforce data consistency
6. **KPIs** - Every action is measured and optimized
7. **Digital Trace** - All conversations and actions logged in Supabase
8. **Continuous Cycle** - Analytics feed back into research for optimization

---

## üìê System Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Command Center (crewAI)                   ‚îÇ
‚îÇ              Orchestrates all modules and agents             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                   ‚îÇ                   ‚îÇ
        ‚ñº                   ‚ñº                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Module 1    ‚îÇ   ‚îÇ   Module 2    ‚îÇ   ‚îÇ   Module 3    ‚îÇ
‚îÇ    Market     ‚îÇ   ‚îÇ    Traffic    ‚îÇ   ‚îÇ     Lead      ‚îÇ
‚îÇ   Research    ‚îÇ‚îÄ‚îÄ‚ñ∂‚îÇ  Generation   ‚îÇ‚îÄ‚îÄ‚ñ∂‚îÇ Qualification ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                   ‚îÇ                   ‚îÇ
        ‚îÇ                   ‚îÇ                   ‚ñº
        ‚îÇ                   ‚îÇ           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                   ‚îÇ           ‚îÇ   Module 4    ‚îÇ
        ‚îÇ                   ‚îÇ           ‚îÇ    Sales      ‚îÇ
        ‚îÇ                   ‚îÇ           ‚îÇ   Handoff     ‚îÇ
        ‚îÇ                   ‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                   ‚îÇ                   ‚îÇ
        ‚ñº                   ‚ñº                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       Module 5: Analytics                    ‚îÇ
‚îÇ              Collects data from all modules                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Supabase (PostgreSQL)                      ‚îÇ
‚îÇ         niches ‚îÇ campaigns ‚îÇ ads ‚îÇ leads ‚îÇ conversations    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üß© Module Breakdown

### Module 1: Market Research (Auto Researcher)

**Purpose:** Identify and analyze profitable niches

**Input:** Niche name, target region
**Output:** NicheAnalysis (profitability score, competition, trends)

**Components:**
- **Scrapy Spiders** - Scrape OLX/Kaspi listings
- **Google Trends API** - Search volume analysis
- **2GIS/Maps Scraper** - Competitor reviews and ratings
- **crewAI Agent** - Aggregate data and generate insights

**Data Flow:**
```
User Input (Niche + Region)
    ‚Üì
Parallel Scraping (OLX, Kaspi, Trends, Reviews)
    ‚Üì
Data Aggregation (crewAI Agent)
    ‚Üì
Profitability Calculation
    ‚Üì
Store in Supabase (market_research table)
    ‚Üì
Return NicheAnalysis
```

**Key Metrics:**
- Average price
- Number of listings
- Competition density (competitors per 10k population)
- Search volume trend
- Seasonality score
- Profitability score (0-100)

---

### Module 2: Traffic Generation (Auto Traffic)

**Purpose:** Generate leads through automated posting and scraping

**Input:** Campaign config (platform, budget, target)
**Output:** Posted ads, scraped leads

**Components:**
- **Playwright Bots** - Automated posting with anti-detect
- **Scrapy Spiders** - Lead scraping from competitors
- **Proxy Manager** - Kazakhstan mobile proxy rotation
- **2Captcha Integration** - CAPTCHA solving
- **Celery Tasks** - Scheduled posting

**Data Flow:**
```
Campaign Created
    ‚Üì
Generate Ad Content (LLM)
    ‚Üì
Select Proxy + Account
    ‚Üì
Playwright: Navigate to OLX/Kaspi
    ‚Üì
Fill Form + Solve CAPTCHA
    ‚Üì
Post Ad
    ‚Üì
Store Ad in Supabase (ads table)
    ‚Üì
Monitor for Responses
    ‚Üì
Create Leads (leads table)
```

**Anti-Detection Techniques:**
- Random delays (2-5s between actions)
- Human-like mouse movements
- Browser fingerprint randomization
- User-Agent rotation
- Cookie management
- Session persistence

---

### Module 3: Lead Qualification (Auto Qualifier)

**Purpose:** Engage leads, qualify intent, attempt to close

**Input:** New lead (phone/Telegram/WhatsApp)
**Output:** Qualified/Disqualified lead with score

**Components:**
- **WAHA** - WhatsApp API (self-hosted)
- **python-telegram-bot** - Telegram bot
- **Botpress** - Conversation flow engine
- **LangChain + GPT-4** - AI-powered responses
- **Qualification Scripts** - Structured questioning

**Data Flow:**
```
Lead Responds to Ad
    ‚Üì
Create Lead in Supabase
    ‚Üì
Trigger Bot (WhatsApp/Telegram)
    ‚Üì
Botpress: Load Conversation Flow
    ‚Üì
LangChain: Generate Response (with memory)
    ‚Üì
Store Message (conversations table)
    ‚Üì
Analyze Intent + Sentiment
    ‚Üì
Calculate Qualification Score
    ‚Üì
If Qualified ‚Üí Module 4 (Handoff)
If Disqualified ‚Üí Mark and Archive
```

**Qualification Criteria:**
- Budget confirmation (can afford service)
- Timeline urgency (when needed)
- Decision authority (can make decision)
- Pain point severity (how badly needed)
- Contact quality (real phone/name)

**Scoring System:**
- 0-30: Disqualified (tire-kicker)
- 31-60: Low quality (nurture)
- 61-80: Qualified (hand off to sales)
- 81-100: Hot lead (immediate attention)

---

### Module 4: Sales Handoff (Auto Handoff)

**Purpose:** Transfer qualified leads to sales team or close directly

**Input:** Qualified lead + conversation history
**Output:** Handoff notification, CRM entry

**Components:**
- **n8n Workflows** - Trigger handoff automation
- **NocoDB** - Lead management interface
- **Apprise** - Multi-channel notifications
- **Telegram Bot** - Sales team notifications

**Data Flow:**
```
Lead Qualified (score > 60)
    ‚Üì
Prepare Lead Package:
  - Lead info
  - Conversation history
  - Qualification data
  - Recommended approach
    ‚Üì
Trigger n8n Webhook
    ‚Üì
n8n: Create NocoDB Entry
    ‚Üì
n8n: Send Notifications (Telegram, Email, SMS)
    ‚Üì
Update Lead Status (handed_off)
    ‚Üì
Track Handoff in Supabase
```

**Lead Package Contents:**
```json
{
  "lead": {
    "id": "uuid",
    "name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
    "phone": "+7 777 123 4567",
    "source": "olx",
    "qualification_score": 85
  },
  "conversation_summary": "Interested in laptop repair, budget 15k, urgent",
  "recommended_approach": "Emphasize fast turnaround time",
  "best_time_to_call": "18:00-20:00",
  "objections_handled": ["price", "warranty"]
}
```

---

### Module 5: Analytics (Auto Analytics)

**Purpose:** Track performance, calculate ROI, generate insights

**Input:** All system data
**Output:** Dashboards, reports, optimization recommendations

**Components:**
- **Pandas** - Data aggregation and analysis
- **Metabase** - BI dashboards
- **Redis** - Caching for expensive calculations
- **crewAI Agent** - Generate insights and recommendations

**Key Metrics:**

**Campaign Level:**
- CPL (Cost Per Lead) = Budget Spent / Total Leads
- ROI = (Revenue - Cost) / Cost √ó 100%
- Conversion Rate = Qualified Leads / Total Leads
- Close Rate = Closed Deals / Qualified Leads
- Response Time = Avg time to first response

**Niche Level:**
- Market Saturation = Competitors / Population
- Price Elasticity = Price Change / Demand Change
- Seasonality Index = Current Volume / Avg Volume
- Profitability Score = (Avg Price - Avg Cost) √ó Volume

**Platform Level:**
- OLX: Views, Contacts, Cost per Contact
- Kaspi: Orders, Conversion Rate
- Telegram: Message Rate, Response Rate
- WhatsApp: Engagement Rate, Qualification Rate

**Data Flow:**
```
Scheduled Job (Daily/Weekly)
    ‚Üì
Fetch Data from Supabase
    ‚Üì
Pandas: Aggregate and Calculate Metrics
    ‚Üì
Cache Results in Redis (TTL: 1h)
    ‚Üì
Update Metabase Dashboards
    ‚Üì
crewAI: Analyze Trends
    ‚Üì
Generate Insights + Recommendations
    ‚Üì
Send Report (Telegram)
```

---

## üóÑÔ∏è Database Schema

### Core Tables

**niches**
```sql
CREATE TABLE niches (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL,
    market VARCHAR(50) NOT NULL, -- 'kazakhstan', 'russia', etc.
    category VARCHAR(100) NOT NULL,
    description TEXT,
    status VARCHAR(50) DEFAULT 'research', -- research, active, paused, archived
    research_data JSONB, -- Store NicheAnalysis
    profitability_score INTEGER,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

**campaigns**
```sql
CREATE TABLE campaigns (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    niche_id UUID REFERENCES niches(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    platform VARCHAR(50) NOT NULL, -- olx, kaspi, telegram, whatsapp
    budget DECIMAL(10,2) NOT NULL,
    budget_spent DECIMAL(10,2) DEFAULT 0,
    target_leads INTEGER,
    status VARCHAR(50) DEFAULT 'draft', -- draft, active, paused, completed
    config JSONB, -- Platform-specific settings
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

**ads**
```sql
CREATE TABLE ads (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    campaign_id UUID REFERENCES campaigns(id) ON DELETE CASCADE,
    platform VARCHAR(50) NOT NULL,
    external_id VARCHAR(255), -- OLX ad ID, etc.
    title VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10,2),
    images JSONB, -- Array of image URLs
    status VARCHAR(50) DEFAULT 'draft', -- draft, posted, active, expired, deleted
    posted_at TIMESTAMP,
    expires_at TIMESTAMP,
    views INTEGER DEFAULT 0,
    contacts INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW()
);
```

**leads**
```sql
CREATE TABLE leads (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    campaign_id UUID REFERENCES campaigns(id) ON DELETE CASCADE,
    source VARCHAR(50) NOT NULL, -- olx, kaspi, telegram, whatsapp
    source_id VARCHAR(255), -- External lead ID
    name VARCHAR(255),
    phone VARCHAR(50),
    telegram_username VARCHAR(255),
    whatsapp_number VARCHAR(50),
    status VARCHAR(50) DEFAULT 'new', -- new, contacted, qualified, disqualified, handed_off, closed
    qualification_score INTEGER,
    qualification_data JSONB,
    assigned_to UUID, -- Sales rep ID
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

**conversations**
```sql
CREATE TABLE conversations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    lead_id UUID REFERENCES leads(id) ON DELETE CASCADE,
    message TEXT NOT NULL,
    sender VARCHAR(50) NOT NULL, -- 'bot', 'lead', 'human'
    platform VARCHAR(50) NOT NULL, -- whatsapp, telegram
    metadata JSONB, -- Intent, sentiment, etc.
    created_at TIMESTAMP DEFAULT NOW()
);
```

**market_research**
```sql
CREATE TABLE market_research (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    niche_id UUID REFERENCES niches(id) ON DELETE CASCADE,
    data_type VARCHAR(50) NOT NULL, -- listings, trends, competitors, reviews
    region VARCHAR(100),
    data JSONB NOT NULL,
    analyzed_at TIMESTAMP DEFAULT NOW()
);
```

### Indexes

```sql
-- Performance indexes
CREATE INDEX idx_campaigns_niche_id ON campaigns(niche_id);
CREATE INDEX idx_campaigns_status ON campaigns(status);
CREATE INDEX idx_ads_campaign_id ON ads(campaign_id);
CREATE INDEX idx_ads_status ON ads(status);
CREATE INDEX idx_leads_campaign_id ON leads(campaign_id);
CREATE INDEX idx_leads_status ON leads(status);
CREATE INDEX idx_leads_created_at ON leads(created_at);
CREATE INDEX idx_conversations_lead_id ON conversations(lead_id);
CREATE INDEX idx_conversations_created_at ON conversations(created_at);
CREATE INDEX idx_market_research_niche_id ON market_research(niche_id);
```

---

## üîÑ Data Flow Example: Complete Cycle

### Scenario: Testing "Laptop Repair" niche in Almaty

**1. Research Phase (Module 1)**
```
User: "Analyze 'Laptop Repair' in Almaty"
    ‚Üì
Scrape OLX: 150 listings, avg price 8,000 KZT
Scrape Kaspi: 80 sellers, avg rating 4.2
Google Trends: Stable search volume
2GIS: 45 competitors, avg 3.8 stars
    ‚Üì
Calculate: Profitability Score = 72/100
    ‚Üì
Store in niches table
    ‚Üì
Return: "Good niche, medium competition, stable demand"
```

**2. Campaign Setup (Module 2)**
```
User: "Create OLX campaign, budget 50,000 KZT"
    ‚Üì
Generate ad copy (LLM): "–ë—ã—Å—Ç—Ä—ã–π —Ä–µ–º–æ–Ω—Ç –Ω–æ—É—Ç–±—É–∫–æ–≤..."
    ‚Üì
Post 5 ads across Almaty districts
    ‚Üì
Monitor for responses
    ‚Üì
Receive 12 contacts in 24h
    ‚Üì
Create 12 leads in database
```

**3. Qualification (Module 3)**
```
Lead responds on WhatsApp: "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Ä–µ–º–æ–Ω—Ç?"
    ‚Üì
Bot: "–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–æ–ª–æ–º–∫–∏. –ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å?"
Lead: "–ù–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è, –∑–∞–ª–∏–ª –≤–æ–¥–æ–π"
    ‚Üì
Bot: "–ü–æ–Ω—è—Ç–Ω–æ. –ö–æ–≥–¥–∞ –Ω—É–∂–µ–Ω —Ä–µ–º–æ–Ω—Ç?"
Lead: "–°—Ä–æ—á–Ω–æ, –∑–∞–≤—Ç—Ä–∞ —ç–∫–∑–∞–º–µ–Ω"
    ‚Üì
Bot: "–ë—é–¥–∂–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ 10-15 —Ç—ã—Å—è—á. –ü–æ–¥—Ö–æ–¥–∏—Ç?"
Lead: "–î–∞, –Ω–æ—Ä–º–∞–ª—å–Ω–æ"
    ‚Üì
Qualification Score: 85 (Hot lead!)
    ‚Üì
Status: qualified
```

**4. Handoff (Module 4)**
```
Lead qualified (score 85)
    ‚Üì
Prepare package:
  - Name: –ê–ª–∏—è
  - Phone: +7 777 123 4567
  - Problem: Water damage, urgent
  - Budget: 10-15k KZT
  - Timeline: Tomorrow
    ‚Üì
Trigger n8n workflow
    ‚Üì
Send Telegram to sales rep:
  "üî• HOT LEAD: –ê–ª–∏—è, +7 777 123 4567
   Problem: Laptop water damage
   Budget: 10-15k, URGENT (tomorrow)
   Score: 85/100"
    ‚Üì
Create NocoDB entry
    ‚Üì
Status: handed_off
```

**5. Analytics (Module 5)**
```
End of Day:
    ‚Üì
Calculate:
  - Total spent: 5,000 KZT (ads)
  - Total leads: 12
  - Qualified: 4
  - CPL: 416 KZT
  - Conversion rate: 33%
    ‚Üì
Generate insight:
  "Campaign performing well. CPL below target.
   Recommend increasing budget to 100k KZT."
    ‚Üì
Send daily report to Telegram
```

---

## üîê Security Architecture

### API Security
- **Authentication:** API keys for internal services
- **Rate Limiting:** 100 req/min per IP
- **Input Validation:** Pydantic models on all endpoints
- **CORS:** Whitelist only known domains

### Data Security
- **Encryption at Rest:** Supabase RLS policies
- **Encryption in Transit:** HTTPS/TLS everywhere
- **Secrets Management:** Environment variables, never in code
- **Access Control:** Role-based access (admin, sales, bot)

### Scraping Ethics
- **Rate Limiting:** Max 1 req/sec per domain
- **User-Agent:** Identify as legitimate bot
- **Robots.txt:** Respect where critical
- **IP Rotation:** Avoid IP bans

---

## üöÄ Deployment Architecture

### Local Development
```
Docker Compose:
  - Supabase (PostgreSQL)
  - Redis
  - n8n
  - Metabase
  - Nginx

Python:
  - FastAPI (uvicorn)
  - Celery workers
  - Scrapy spiders
```

### Production (VPS)
```
DigitalOcean Droplet (8GB RAM, 4 vCPU):
  ‚îú‚îÄ‚îÄ Nginx (reverse proxy, SSL)
  ‚îú‚îÄ‚îÄ FastAPI (systemd service)
  ‚îú‚îÄ‚îÄ Celery (systemd service)
  ‚îú‚îÄ‚îÄ Docker Compose (Supabase, Redis, n8n, Metabase)
  ‚îú‚îÄ‚îÄ WAHA (WhatsApp API)
  ‚îî‚îÄ‚îÄ Monitoring (logs, metrics)
```

### Scaling Strategy
- **Horizontal:** Multiple Celery workers
- **Vertical:** Increase VPS resources
- **Database:** Supabase handles scaling
- **Caching:** Redis for hot data

---

## üìä Monitoring & Observability

### Metrics to Track
- **API:** Response time, error rate, throughput
- **Scraping:** Success rate, CAPTCHA rate, proxy health
- **Bots:** Response time, qualification rate
- **Business:** CPL, ROI, conversion rate

### Logging Strategy
- **Structured Logging:** JSON format
- **Log Levels:** DEBUG (dev), INFO (prod), ERROR (alerts)
- **Log Storage:** Files + Supabase (critical events)
- **Log Rotation:** Daily, keep 30 days

### Alerting
- **Critical:** API down, database connection lost
- **Warning:** High error rate, slow response time
- **Info:** Daily reports, campaign completed

---

## üîÑ CI/CD Pipeline (Future)

```
Git Push
    ‚Üì
GitHub Actions:
  - Run tests (pytest)
  - Lint code (ruff, mypy)
  - Build Docker image
  - Security scan
    ‚Üì
If tests pass:
  - Deploy to staging
  - Run integration tests
    ‚Üì
If approved:
  - Deploy to production
  - Run smoke tests
  - Notify team
```

---

## üìö Technology Decisions

### Why FastAPI?
- ‚úÖ Async/await support (critical for I/O-heavy workload)
- ‚úÖ Automatic API documentation (Swagger)
- ‚úÖ Pydantic integration (type safety)
- ‚úÖ High performance (comparable to Node.js)
- ‚úÖ Modern Python (3.9+)

### Why Supabase?
- ‚úÖ PostgreSQL (proven, reliable)
- ‚úÖ Real-time subscriptions (for live dashboards)
- ‚úÖ Row-level security (data isolation)
- ‚úÖ Self-hostable (no vendor lock-in)
- ‚úÖ Free tier (5GB storage, 500MB database)

### Why crewAI?
- ‚úÖ Multi-agent orchestration (perfect for modular system)
- ‚úÖ LangChain integration (LLM flexibility)
- ‚úÖ Task delegation (agents work together)
- ‚úÖ Python-native (same stack)

### Why Playwright over Selenium?
- ‚úÖ Modern API (async/await)
- ‚úÖ Better anti-detect capabilities
- ‚úÖ Faster execution
- ‚úÖ Built-in waiting mechanisms
- ‚úÖ Network interception

### Why WAHA for WhatsApp?
- ‚úÖ Self-hosted (no monthly fees)
- ‚úÖ HTTP API (easy integration)
- ‚úÖ Multi-session support
- ‚úÖ QR code authentication
- ‚úÖ Open source

---

## üéØ Future Enhancements

### Phase 2 (Q1 2025)
- [ ] Instagram/Facebook scraping
- [ ] Google Ads integration
- [ ] Yandex Direct integration
- [ ] Voice call qualification (Twilio)
- [ ] Mobile app for sales team

### Phase 3 (Q2 2025)
- [ ] Multi-language support (Kazakh, English)
- [ ] Predictive analytics (ML models)
- [ ] Automatic niche discovery
- [ ] White-label solution for agencies
- [ ] API marketplace for integrations

---

**Last Updated:** 2024-11-16  
**Version:** 0.0 Demo  
**Status:** Active Development

