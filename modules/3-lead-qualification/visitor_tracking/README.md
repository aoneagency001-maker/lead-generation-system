# Visitor Tracking Module

**–ú–æ–¥—É–ª—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π —Å–∞–π—Ç–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–æ–∫ —Å –ª–µ–Ω–¥–∏–Ω–≥–æ–≤**

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è [telegram-notifications-service](https://github.com/aoneagency001-maker/telegram-notifications-service) –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É Lead Generation System.

## üéØ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π** (`/track-visitor`) - —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è—Ö –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ **Tilda Webhook** (`/tilda-webhook`) - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—è–≤–æ–∫ —Å –ª–µ–Ω–¥–∏–Ω–≥–æ–≤ Tilda
- ‚úÖ **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –±–æ—Ç–æ–≤** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Ä–æ–±–æ—Ç–æ–≤
- ‚úÖ **–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ IP** - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –∏ —Å—Ç—Ä–∞–Ω—ã –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
- ‚úÖ **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞** - –º–æ–±–∏–ª—å–Ω–æ–µ/–ø–ª–∞–Ω—à–µ—Ç/–¥–µ—Å–∫—Ç–æ–ø
- ‚úÖ **UTM-–º–µ—Ç–∫–∏** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ç—Ä–∞—Ñ–∏–∫–∞
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è—Ö –∏ –∑–∞—è–≤–∫–∞—Ö

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.9+
- Supabase (PostgreSQL)
- Telegram Bot Token –∏ Chat ID (–¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard ‚Üí SQL Editor –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```sql
-- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
-- core/database/schema_visitor_tracking.sql
```

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç:

```bash
python scripts/apply_schema_visitor_tracking.py
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `.env` —Ñ–∞–π–ª–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:

```bash
# Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π telegram_notifier)
TELEGRAM_MONITOR_BOT_TOKEN=your_bot_token
TELEGRAM_MONITOR_CHAT_ID=your_chat_id

# Supabase
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_KEY=your_supabase_key
```

### 3. –ú–æ–¥—É–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ API

–ú–æ–¥—É–ª—å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ `core/api/main.py` –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

## üì° API Endpoints

### POST `/api/visitor-tracking/track-visitor`

–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram.

**Request Body:**

```json
{
  "page": "/ru",
  "landingPage": "/ru",
  "referrer": "https://google.com",
  "screenResolution": "1920x1080",
  "sessionId": "uuid-session-id",
  "utmSource": "yandex",
  "utmMedium": "cpc",
  "utmCampaign": "summer2024",
  "utmTerm": "—Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥ –∞–ª–º–∞—Ç—ã",
  "utmContent": "banner_1",
  "isFirstVisit": true
}
```

**Response:**

```json
{
  "tracked": true,
  "visitorId": "uuid-visitor-id",
  "requestId": "abc123"
}
```

### POST `/api/visitor-tracking/tilda-webhook`

–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç webhook –æ—Ç Tilda –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram.

**Request Body:**

```json
{
  "name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
  "phone": "+7 777 123 45 67",
  "email": "ivan@example.com",
  "message": "–•–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É —Å–∞–π—Ç–∞",
  "formName": "Contact Form",
  "pageUrl": "https://example.com/contact"
}
```

**Response:**

```json
{
  "success": true,
  "message": "Notification sent",
  "requestId": "abc123"
}
```

### GET `/api/visitor-tracking/health`

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª—è.

**Response:**

```json
{
  "status": "ok",
  "service": "visitor-tracking",
  "timestamp": "2025-11-21T12:00:00.000Z"
}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è

```bash
curl -X POST http://localhost:8000/api/visitor-tracking/track-visitor \
  -H "Content-Type: application/json" \
  -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
  -d '{
    "page": "/ru",
    "referrer": "https://google.com",
    "screenResolution": "1920x1080",
    "utmSource": "yandex",
    "utmMedium": "cpc"
  }'
```

### –¢–µ—Å—Ç Tilda webhook

```bash
curl -X POST http://localhost:8000/api/visitor-tracking/tilda-webhook \
  -H "Content-Type: application/json" \
  -d '{
    "name": "–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
    "phone": "+7 777 123 45 67",
    "email": "test@example.com",
    "message": "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
  }'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ health endpoint

```bash
curl http://localhost:8000/api/visitor-tracking/health
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

```
visitor_tracking/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ models.py                    # Pydantic –º–æ–¥–µ–ª–∏
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ routes.py                # FastAPI —Ä–æ—É—Ç—ã
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ visitor_tracker.py       # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ tilda_webhook.py         # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Tilda webhook
‚îÇ   ‚îú‚îÄ‚îÄ bot_detector.py          # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–æ—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ geo_location.py          # –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ IP
‚îÇ   ‚îî‚îÄ‚îÄ message_formatter.py     # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îî‚îÄ‚îÄ README.md
```

## üîç –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ú–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏:

- `[TRACK-xxx]` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
- `[TILDA-xxx]` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ Tilda webhook
- `[TELEGRAM]` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
- `[BOT-DETECTOR]` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–æ—Ç–æ–≤
- `[GEO-LOCATION]` - –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è

## ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- **–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å ip-api.com (45 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É)
- **–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:** –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è in-memory storage –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π. –î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis
- **Rate limiting:** –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Tilda

1. –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä–º—ã –≤ Tilda
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä–º—ã" ‚Üí "–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö"
3. –í—ã–±–µ—Ä–∏—Ç–µ "Webhook"
4. –£–∫–∞–∂–∏—Ç–µ URL: `https://your-domain.com/api/visitor-tracking/tilda-webhook`
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

## üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–ú–æ–¥—É–ª—å —Å–æ–∑–¥–∞–µ—Ç –¥–≤–µ —Ç–∞–±–ª–∏—Ü—ã:

- `visitors` - –¥–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è—Ö —Å–∞–π—Ç–∞
- `tilda_webhooks` - –∏—Å—Ç–æ—Ä–∏—è webhook –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç Tilda

–°—Ö–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤: `core/database/schema_visitor_tracking.sql`

## üõ†Ô∏è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π

1. –û–±–Ω–æ–≤–∏—Ç–µ –º–æ–¥–µ–ª—å –≤ `models.py`
2. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ö–µ–º—É –ë–î –≤ `schema_visitor_tracking.sql`
3. –û–±–Ω–æ–≤–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã –≤ `services/`
4. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –≤ Supabase

### –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `services/message_formatter.py` –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

## ü§ù –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
2. –õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞
3. –°—Ç–∞—Ç—É—Å Telegram Bot API
4. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ CORS (–µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç —Å –¥—Ä—É–≥–æ–≥–æ –¥–æ–º–µ–Ω–∞)
5. –°—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—Ç–∞–±–ª–∏—Ü—ã –¥–æ–ª–∂–Ω—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å)

